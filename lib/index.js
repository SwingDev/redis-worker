var ERR_DRY_POOL, RedisConnectionManager, Worker, WorkerError, async, createError, domain, errors,
  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

domain = require('domain');

async = require('async');

RedisConnectionManager = require("redis-connection-manager").RedisConnectionManager;

errors = require('./errors');

createError = errors.createError;

WorkerError = errors.WorkerError;

ERR_DRY_POOL = errors.ERR_DRY_POOL;

Worker = (function() {
  Worker.prototype.gracefulShutdownTimeout = 15000;

  Worker.prototype.tasksRunning = 0;

  Worker.prototype.incRunningTasks = function() {
    return this.tasksRunning += 1;
  };

  Worker.prototype.decRunningTasks = function() {
    this.tasksRunning -= 1;
    if (!this.tasksRunning) {
      if (this.drainCallback != null) {
        return this.drainCallback();
      }
    }
  };

  function Worker(url, taskLimit) {
    this.url = url;
    this.taskLimit = taskLimit;
    this.handleTaskDomainError = bind(this.handleTaskDomainError, this);
    this.decRunningTasks = bind(this.decRunningTasks, this);
    this.incRunningTasks = bind(this.incRunningTasks, this);
    if (!this.url) {
      throw new Error('You must create Worker with Redis Url');
    }
    if (this.taskLimit == null) {
      this.taskLimit = 2;
    }
    this.taskNo = 1;
    this.redisQueueEmpty = false;
    this.shuttingDown = false;
    this.workerDomain = domain.create();
    this.workerDomain.on('error', (function(_this) {
      return function(err) {
        return _this.handleTaskDomainError(err);
      };
    })(this));
    this.queue = async.queue((function(_this) {
      return function(task, callback) {
        _this.workerDomain.enter();
        process.nextTick(function() {
          return _this.checkAndRunTask(function(err) {
            if (err) {
              console.error(err);
            }
            callback(null);
            return _this._fetchJobFromRedisToQueue();
          });
        });
        return _this.workerDomain.exit();
      };
    })(this), this.taskLimit);
  }

  Worker.prototype.name = function() {
    throw new Error('You must overwrite Worker#name in subclass');
  };

  Worker.prototype.listKey = function() {
    return "worker:list:" + (this.name());
  };

  Worker.prototype.channelKey = function() {
    return "worker:channel:" + (this.name());
  };

  Worker.prototype.obtainListClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'list', done);
  };

  Worker.prototype.obtainChannelClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'channel', done);
  };

  Worker.prototype.popJobFromQueue = function(cb) {
    return this.obtainListClient((function(_this) {
      return function(err, client) {
        if (err) {
          return cb(createError(err, 'LISTNOTFOUND'));
        }
        return client.lpop(_this.listKey(), cb);
      };
    })(this));
  };

  Worker.prototype.checkAndRunTask = function(cb) {
    return this.popJobFromQueue((function(_this) {
      return function(err, task) {
        if (err) {
          return cb(createError(err, 'POPJOB'));
        }
        if (!task) {
          _this.redisQueueEmpty = true;
          return cb();
        }
        _this.redisQueueEmpty = false;
        _this.incRunningTasks();
        return _this.work(task, function(err) {
          _this.decRunningTasks();
          if (!err) {
            return cb();
          }
          return _this.error(err, task, function(err) {
            if (err) {
              return cb(createError(err, 'RUNTASK'));
            }
            return cb(null);
          });
        });
      };
    })(this));
  };

  Worker.prototype.work = function() {
    throw new Error('You must overwrite Worker#work in subclass');
  };

  Worker.prototype.error = function() {
    throw new Error('You must overwrite Worker#error in subclass');
  };

  Worker.prototype.handleTaskDomainError = function(err) {
    var postWorkHook;
    console.error("Detected an unknown error <" + err + ">, shutting down after this cycle or in " + (this.gracefulShutdownTimeout / 1000.0) + " seconds.");
    console.error(err.stack);
    if (!this.shuttingDown) {
      this.shuttingDown = true;
      postWorkHook = (function(_this) {
        return function() {
          if (!_this.shutDown) {
            console.warn("Post work, shutting down.");
            _this.workerDomain.dispose();
            process.exit(-1);
          }
          return _this.shutDown = true;
        };
      })(this);
      this.drainCallback = postWorkHook;
      setTimeout(postWorkHook, this.gracefulShutdownTimeout);
    }
    return this.decRunningTasks();
  };

  Worker.prototype.waitForTasks = function(cb) {
    return this.obtainChannelClient((function(_this) {
      return function(err, channel_client) {
        if (err) {
          return cb(createError(err, 'CHANNELNOTFOUND'));
        }
        _this.obtainListClient(function(err, list_client) {
          return list_client.llen(_this.listKey(), function(err, length) {
            var i, idx, prequeuedTasksNo, ref, results;
            prequeuedTasksNo = Math.max(1, Math.min(length, _this.taskLimit));
            if (length) {
              results = [];
              for (idx = i = 1, ref = prequeuedTasksNo; 1 <= ref ? i <= ref : i >= ref; idx = 1 <= ref ? ++i : --i) {
                results.push(_this._fetchJobFromRedisToQueue());
              }
              return results;
            }
          });
        });
        channel_client.on('message', function(channel, message) {
          if (channel === _this.channelKey()) {
            if (!_this._canTakeNewTasks()) {
              return;
            }
            return _this._fetchJobFromRedisToQueue(true);
          }
        });
        channel_client.subscribe(_this.channelKey());
        return cb();
      };
    })(this));
  };

  Worker.prototype.pushJob = function(jobDict, cb) {
    var payload;
    payload = JSON.stringify(jobDict);
    return async.series([
      (function(_this) {
        return function(callback) {
          return _this.obtainListClient(function(err, client) {
            if (err) {
              return callback(createError(err, 'LISTNOTFOUND'));
            }
            return client.rpush(_this.listKey(), payload, callback);
          });
        };
      })(this), (function(_this) {
        return function(callback) {
          return _this.obtainListClient(function(err, client) {
            if (err) {
              return callback(createError(err, 'LISTNOTFOUND'));
            }
            return client.publish(_this.channelKey(), payload, callback);
          });
        };
      })(this)
    ], function(err) {
      if (err) {
        return cb(createError(err, 'PUSHJOB'));
      }
      return cb(null);
    });
  };

  Worker.prototype._canTakeNewTasks = function() {
    return this.queue.running() + this.queue.length() < this.taskLimit;
  };

  Worker.prototype._fetchJobFromRedisToQueue = function(force) {
    var tmpTaskNo;
    if ((!this.redisQueueEmpty || force) && !this.shuttingDown) {
      tmpTaskNo = this.taskNo;
      this.queue.push(this.taskNo, function(err) {});
      return this.taskNo++;
    }
  };

  return Worker;

})();


/* */

exports.Worker = Worker;

exports.WorkerError = WorkerError;

//# sourceMappingURL=data:application/json;base64,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ZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbImRvbWFpbiA9IHJlcXVpcmUoJ2RvbWFpbicpXG5hc3luYyAgID0gcmVxdWlyZSgnYXN5bmMnKVxuXG5SZWRpc0Nvbm5lY3Rpb25NYW5hZ2VyID0gcmVxdWlyZShcInJlZGlzLWNvbm5lY3Rpb24tbWFuYWdlclwiKS5SZWRpc0Nvbm5lY3Rpb25NYW5hZ2VyXG5lcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpXG5cbmNyZWF0ZUVycm9yID0gZXJyb3JzLmNyZWF0ZUVycm9yXG5Xb3JrZXJFcnJvciA9IGVycm9ycy5Xb3JrZXJFcnJvclxuRVJSX0RSWV9QT09MID0gZXJyb3JzLkVSUl9EUllfUE9PTFxuXG5cbmNsYXNzIFdvcmtlclxuXG4gIGdyYWNlZnVsU2h1dGRvd25UaW1lb3V0OiAxNTAwMFxuICB0YXNrc1J1bm5pbmc6IDBcblxuICBpbmNSdW5uaW5nVGFza3M6ICgpID0+XG4gICAgQHRhc2tzUnVubmluZyArPSAxXG5cbiAgZGVjUnVubmluZ1Rhc2tzOiAoKSA9PlxuICAgIEB0YXNrc1J1bm5pbmcgLT0gMVxuICAgIHVubGVzcyBAdGFza3NSdW5uaW5nXG4gICAgICBAZHJhaW5DYWxsYmFjaygpIGlmIEBkcmFpbkNhbGxiYWNrP1xuXG4gIGNvbnN0cnVjdG9yOiAoQHVybCwgQHRhc2tMaW1pdCkgLT5cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IGNyZWF0ZSBXb3JrZXIgd2l0aCBSZWRpcyBVcmwnKSB1bmxlc3MgQHVybFxuICAgIEB0YXNrTGltaXQgPz0gMlxuICAgIEB0YXNrTm8gPSAxXG4gICAgQHJlZGlzUXVldWVFbXB0eSA9IGZhbHNlXG4gICAgQHNodXR0aW5nRG93biA9IGZhbHNlXG5cbiAgICBAd29ya2VyRG9tYWluID0gZG9tYWluLmNyZWF0ZSgpXG5cbiAgICBAd29ya2VyRG9tYWluLm9uICdlcnJvcicsIChlcnIpID0+XG4gICAgICBAaGFuZGxlVGFza0RvbWFpbkVycm9yIGVyclxuXG4gICAgQHF1ZXVlID0gYXN5bmMucXVldWUoKHRhc2ssIGNhbGxiYWNrKSA9PlxuICAgICAgIyBjb25zb2xlLmxvZyAnXFxuPj4+Pj4gUVVFVUUnXG4gICAgICAjIGNvbnNvbGUubG9nICc+Pj4+PiB0YXNrbGltaXQnLCBAdGFza0xpbWl0XG4gICAgICAjIGNvbnNvbGUubG9nICc+Pj4+PiBjb25jdXJlbmN5IHZhbCcsIEBxdWV1ZS5jb25jdXJyZW5jeVxuICAgICAgIyBjb25zb2xlLmxvZyAnPj4+Pj4gbnVtYmVyIG9mIHRhc2tzIGluIHF1ZXVlJywgQHF1ZXVlLmxlbmd0aCgpXG4gICAgICAjIGNvbnNvbGUubG9nICc+Pj4+PiBudW1iZXIgb2YgdGFza3MgcnVubmluZycsIEBxdWV1ZS5ydW5uaW5nKCksICdcXG4nXG5cbiAgICAgIEB3b3JrZXJEb21haW4uZW50ZXIoKVxuICAgICAgcHJvY2Vzcy5uZXh0VGljayAoKSA9PlxuICAgICAgICBAY2hlY2tBbmRSdW5UYXNrIChlcnIpID0+XG4gICAgICAgICAgY29uc29sZS5lcnJvciBlcnIgaWYgZXJyXG5cbiAgICAgICAgICBjYWxsYmFjayBudWxsXG4gICAgICAgICAgQF9mZXRjaEpvYkZyb21SZWRpc1RvUXVldWUoKVxuICAgICAgQHdvcmtlckRvbWFpbi5leGl0KClcblxuICAgICwgQHRhc2tMaW1pdClcblxuICBuYW1lOiAoKSAtPlxuICAgIHRocm93IG5ldyBFcnJvcignWW91IG11c3Qgb3ZlcndyaXRlIFdvcmtlciNuYW1lIGluIHN1YmNsYXNzJylcblxuICAjIFJlZGlzXG4gIGxpc3RLZXk6ICAgICgpIC0+IFwid29ya2VyOmxpc3Q6I3tAbmFtZSgpfVwiXG4gIGNoYW5uZWxLZXk6ICgpIC0+IFwid29ya2VyOmNoYW5uZWw6I3tAbmFtZSgpfVwiXG5cbiAgb2J0YWluTGlzdENsaWVudDogICAgKGRvbmUpIC0+IFJlZGlzQ29ubmVjdGlvbk1hbmFnZXIub2J0YWluQ2xpZW50IEB1cmwsICdsaXN0JywgZG9uZVxuICBvYnRhaW5DaGFubmVsQ2xpZW50OiAoZG9uZSkgLT4gUmVkaXNDb25uZWN0aW9uTWFuYWdlci5vYnRhaW5DbGllbnQgQHVybCwgJ2NoYW5uZWwnLCBkb25lXG5cbiAgIyBJbnRlcm5hbFxuICBwb3BKb2JGcm9tUXVldWU6IChjYikgLT5cbiAgICAjIGNvbnNvbGUubG9nICc+PiBQT1BKT0InXG4gICAgQG9idGFpbkxpc3RDbGllbnQgKGVyciwgY2xpZW50KSA9PlxuICAgICAgcmV0dXJuIGNiIGNyZWF0ZUVycm9yKGVyciwgJ0xJU1ROT1RGT1VORCcpIGlmIGVyclxuICAgICAgY2xpZW50Lmxwb3AgQGxpc3RLZXkoKSwgY2JcblxuICBjaGVja0FuZFJ1blRhc2s6IChjYikgLT5cbiAgICAjIGNvbnNvbGUubG9nICc+IENIRUNLUlVOJ1xuICAgIEBwb3BKb2JGcm9tUXVldWUgKGVycix0YXNrKSA9PlxuICAgICAgcmV0dXJuIGNiIGNyZWF0ZUVycm9yKGVyciwgJ1BPUEpPQicpIGlmIGVyclxuICAgICAgdW5sZXNzIHRhc2tcbiAgICAgICAgIyBjb25zb2xlLmxvZyAnPj4+IE5PIE1PUkUgVEFTS1MnXG4gICAgICAgIEByZWRpc1F1ZXVlRW1wdHkgPSB0cnVlXG4gICAgICAgIHJldHVybiBjYigpXG5cbiAgICAgIEByZWRpc1F1ZXVlRW1wdHkgPSBmYWxzZVxuICAgICAgIyBjb25zb2xlLmxvZyAnPj4+IFRBU0sgU1RBUlQgSk9CJ1xuXG4gICAgICBAaW5jUnVubmluZ1Rhc2tzKClcbiAgICAgIEB3b3JrIHRhc2ssIChlcnIpID0+XG4gICAgICAgIEBkZWNSdW5uaW5nVGFza3MoKVxuXG4gICAgICAgIHJldHVybiBjYigpIHVubGVzcyBlcnJcbiAgICAgICAgQGVycm9yIGVyciwgdGFzaywgKGVycikgLT5cbiAgICAgICAgICByZXR1cm4gY2IgY3JlYXRlRXJyb3IoZXJyLCAnUlVOVEFTSycpIGlmIGVyclxuICAgICAgICAgIGNiIG51bGxcblxuICAjIFN1YmNsYXNzIEFQSVxuICB3b3JrOiAoKSAtPlxuICAgIHRocm93IG5ldyBFcnJvcignWW91IG11c3Qgb3ZlcndyaXRlIFdvcmtlciN3b3JrIGluIHN1YmNsYXNzJylcblxuICBlcnJvcjogKCkgLT5cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IG92ZXJ3cml0ZSBXb3JrZXIjZXJyb3IgaW4gc3ViY2xhc3MnKVxuXG4gIGhhbmRsZVRhc2tEb21haW5FcnJvcjogKGVycikgPT5cbiAgICBjb25zb2xlLmVycm9yIFwiRGV0ZWN0ZWQgYW4gdW5rbm93biBlcnJvciA8I3tlcnJ9Piwgc2h1dHRpbmcgZG93biBhZnRlciB0aGlzIGN5Y2xlIG9yIGluICN7QGdyYWNlZnVsU2h1dGRvd25UaW1lb3V0LzEwMDAuMH0gc2Vjb25kcy5cIlxuICAgIGNvbnNvbGUuZXJyb3IgZXJyLnN0YWNrXG5cbiAgICB1bmxlc3MgQHNodXR0aW5nRG93blxuICAgICAgQHNodXR0aW5nRG93biA9IHRydWVcblxuICAgICAgcG9zdFdvcmtIb29rID0gKCkgPT5cbiAgICAgICAgIyBGbGFnIHVzZWQgaW4gdGVzdGluZywgd2hlcmUgd2UgbW9jayAncHJvY2Vzcy5leGl0Jy5cbiAgICAgICAgIyBVbmRlciBub3JtYWwgY2lyY3Vtc3RhbmNlc3MgcHJvY2Vzcy5leGl0IHdpbGwga2lsbCB0aGlzIHdvcmtlciBpbW1lZGlhdGVseS5cbiAgICAgICAgdW5sZXNzIEBzaHV0RG93blxuICAgICAgICAgIGNvbnNvbGUud2FybiBcIlBvc3Qgd29yaywgc2h1dHRpbmcgZG93bi5cIlxuICAgICAgICAgIEB3b3JrZXJEb21haW4uZGlzcG9zZSgpXG4gICAgICAgICAgcHJvY2Vzcy5leGl0IC0xXG5cbiAgICAgICAgQHNodXREb3duID0gdHJ1ZVxuXG4gICAgICBAZHJhaW5DYWxsYmFjayA9IHBvc3RXb3JrSG9va1xuICAgICAgc2V0VGltZW91dCBwb3N0V29ya0hvb2ssIEBncmFjZWZ1bFNodXRkb3duVGltZW91dFxuXG4gICAgQGRlY1J1bm5pbmdUYXNrcygpXG5cbiAgIyBBUElcbiAgd2FpdEZvclRhc2tzOiAoY2IpIC0+XG4gICAgQG9idGFpbkNoYW5uZWxDbGllbnQgKGVyciwgY2hhbm5lbF9jbGllbnQpID0+XG4gICAgICByZXR1cm4gY2IgY3JlYXRlRXJyb3IoZXJyLCAnQ0hBTk5FTE5PVEZPVU5EJykgaWYgZXJyXG5cbiAgICAgIEBvYnRhaW5MaXN0Q2xpZW50IChlcnIsIGxpc3RfY2xpZW50KSA9PiAjIEBUT0RPOiBXaHkgaXMgdGhpcyBuZWNlc3Nhcnk/XG4gICAgICAgIGxpc3RfY2xpZW50LmxsZW4gQGxpc3RLZXkoKSwgKGVyciwgbGVuZ3RoKSA9PlxuICAgICAgICAgIHByZXF1ZXVlZFRhc2tzTm8gPSBNYXRoLm1heCgxLCBNYXRoLm1pbihsZW5ndGgsIEB0YXNrTGltaXQpKVxuXG4gICAgICAgICAgQF9mZXRjaEpvYkZyb21SZWRpc1RvUXVldWUoKSBmb3IgaWR4IGluIFsxLi5wcmVxdWV1ZWRUYXNrc05vXSBpZiBsZW5ndGhcblxuICAgICAgIyBAVE9ETzogV2h5IGRvZXNuJ3QgdGhpcyBhbG9uZSB3b3JrP1xuICAgICAgIyBAX2ZldGNoSm9iRnJvbVJlZGlzVG9RdWV1ZSgpIGZvciBpZHggaW4gWzEuLjJdXG5cbiAgICAgIGNoYW5uZWxfY2xpZW50Lm9uICdtZXNzYWdlJywgKGNoYW5uZWwsIG1lc3NhZ2UpID0+XG4gICAgICAgICMgY29uc29sZS5sb2cgJ1xcbj4+Pj4+IE1TRycsIG1lc3NhZ2Uuc3Vic3RyKDM4LDcwKSwgJ1xcbidcbiAgICAgICAgaWYgY2hhbm5lbCA9PSBAY2hhbm5lbEtleSgpXG4gICAgICAgICAgcmV0dXJuIHVubGVzcyBAX2NhblRha2VOZXdUYXNrcygpXG4gICAgICAgICAgQF9mZXRjaEpvYkZyb21SZWRpc1RvUXVldWUodHJ1ZSlcblxuICAgICAgY2hhbm5lbF9jbGllbnQuc3Vic2NyaWJlKEBjaGFubmVsS2V5KCkpXG5cbiAgICAgIGNiKClcblxuICBwdXNoSm9iOiAoam9iRGljdCwgY2IpIC0+XG4gICAgIyBjb25zb2xlLmxvZyAnUFVTSEpPQidcbiAgICBwYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoam9iRGljdClcbiAgICBhc3luYy5zZXJpZXMgW1xuICAgICAgKGNhbGxiYWNrKSA9PlxuICAgICAgICBAb2J0YWluTGlzdENsaWVudCAoZXJyLGNsaWVudCkgPT5cbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2sgY3JlYXRlRXJyb3IoZXJyLCAnTElTVE5PVEZPVU5EJykgaWYgZXJyXG4gICAgICAgICAgY2xpZW50LnJwdXNoKEBsaXN0S2V5KCksIHBheWxvYWQsIGNhbGxiYWNrKVxuICAgICAgKGNhbGxiYWNrKSA9PlxuICAgICAgICBAb2J0YWluTGlzdENsaWVudCAoZXJyLGNsaWVudCkgPT5cbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2sgY3JlYXRlRXJyb3IoZXJyLCAnTElTVE5PVEZPVU5EJykgaWYgZXJyXG4gICAgICAgICAgY2xpZW50LnB1Ymxpc2goQGNoYW5uZWxLZXkoKSwgcGF5bG9hZCwgY2FsbGJhY2spXG4gICAgXSwgKGVycikgLT5cbiAgICAgIHJldHVybiBjYiBjcmVhdGVFcnJvcihlcnIsICdQVVNISk9CJykgaWYgZXJyXG4gICAgICBjYiBudWxsXG5cbiAgX2NhblRha2VOZXdUYXNrczogKCkgLT5cbiAgICByZXR1cm4gQHF1ZXVlLnJ1bm5pbmcoKStAcXVldWUubGVuZ3RoKCkgPCBAdGFza0xpbWl0XG5cbiAgX2ZldGNoSm9iRnJvbVJlZGlzVG9RdWV1ZTogKGZvcmNlKSAtPlxuICAgIGlmIChub3QgQHJlZGlzUXVldWVFbXB0eSBvciBmb3JjZSkgYW5kIG5vdCBAc2h1dHRpbmdEb3duXG4gICAgICB0bXBUYXNrTm8gPSBAdGFza05vXG4gICAgICBAcXVldWUucHVzaCBAdGFza05vLCAoZXJyKSAtPlxuICAgICAgICAjIGNvbnNvbGUubG9nICdcXG4+Pj4+IEZJTklTSEVEIFRBU0snLCB0bXBUYXNrTm8sICdcXG4nXG4gICAgICAgIHJldHVyblxuICAgICAgIyBjb25zb2xlLmxvZyAnPj4+Pj4gRkVUQ0hFRCBqb2IgYW5kIGFkZGVkIHRvIFFVRVVFJ1xuICAgICAgIyBjb25zb2xlLmxvZyAndGFza05vJywgQHRhc2tOb1xuICAgICAgIyBjb25zb2xlLmxvZyAndGFza0xpbWl0JywgQHRhc2tMaW1pdFxuICAgICAgIyBjb25zb2xlLmxvZyAnY2FuIHRha2UgbmV3IHRhc2tzJywgQF9jYW5UYWtlTmV3VGFza3MoKVxuICAgICAgQHRhc2tObysrXG4gXG5cbiMjIyAjIyNcbiMgRVhQT1JUU1xuZXhwb3J0cy5Xb3JrZXIgPSBXb3JrZXJcbmV4cG9ydHMuV29ya2VyRXJyb3IgPSBXb3JrZXJFcnJvclxuIl19
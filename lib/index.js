var ERR_DRY_POOL, RedisConnectionManager, Worker, WorkerError, async, createError, errors;

async = require('async');

RedisConnectionManager = require("redis-connection-manager").RedisConnectionManager;

errors = require('./errors');

createError = errors.createError;

WorkerError = errors.WorkerError;

ERR_DRY_POOL = errors.ERR_DRY_POOL;

Worker = (function() {
  function Worker(url) {
    this.url = url;
    if (!this.url) {
      throw new Error('You must create Worker with Redis Url');
    }
  }

  Worker.prototype.name = function() {
    throw new Error('You must overwrite Worker#name in subclass');
  };

  Worker.prototype.listKey = function() {
    return "worker:list:" + (this.name());
  };

  Worker.prototype.channelKey = function() {
    return "worker:channel:" + (this.name());
  };

  Worker.prototype.obtainListClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'list', done);
  };

  Worker.prototype.obtainChannelClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'channel', done);
  };

  Worker.prototype.popJobFromQueue = function(cb) {
    return this.obtainListClient((function(_this) {
      return function(err, client) {
        if (err) {
          return cb(createError(err, 'LISTNOTFOUND'));
        }
        return client.lpop(_this.listKey(), cb);
      };
    })(this));
  };

  Worker.prototype.checkAndRunTask = function(cb) {
    if (this.busy) {
      return cb();
    }
    this.busy = true;
    return async.forever((function(_this) {
      return function(next) {
        return _this.popJobFromQueue(function(err, task) {
          if (err) {
            return next(createError(err, 'POPJOB'));
          }
          if (!task) {
            return next(ERR_DRY_POOL);
          }
          return _this.work(task, function(err) {
            if (err) {
              return _this.error(err, task, function(err) {
                return next(createError(err, 'RUNTASK'));
              });
            } else {
              return next();
            }
          });
        });
      };
    })(this), (function(_this) {
      return function(err) {
        _this.busy = false;
        if (err === ERR_DRY_POOL) {
          return cb();
        } else if (err) {
          return cb(err);
        }
      };
    })(this));
  };

  Worker.prototype.work = function() {
    throw new Error('You must overwrite Worker#work in subclass');
  };

  Worker.prototype.error = function() {
    throw new Error('You must overwrite Worker#error in subclass');
  };

  Worker.prototype.waitForTasks = function(cb) {
    return this.obtainChannelClient((function(_this) {
      return function(err, client) {
        if (err) {
          return cb(createError(err, 'CHANNELNOTFOUND'));
        }
        _this.checkAndRunTask(function(err) {
          if (err) {
            return cb(err);
          }
        });
        client.on('message', function(channel, message) {
          if (channel === _this.channelKey()) {
            return _this.checkAndRunTask(function(err) {
              if (err) {
                return cb(err);
              }
            });
          }
        });
        client.subscribe(_this.channelKey());
        return cb();
      };
    })(this));
  };

  Worker.prototype.pushJob = function(jobDict, cb) {
    var payload;
    payload = JSON.stringify(jobDict);
    return async.series([
      (function(_this) {
        return function(callback) {
          return _this.obtainListClient(function(err, client) {
            if (err) {
              return callback(createError(err, 'LISTNOTFOUND'));
            }
            return client.rpush(_this.listKey(), payload, callback);
          });
        };
      })(this), (function(_this) {
        return function(callback) {
          return _this.obtainListClient(function(err, client) {
            if (err) {
              return callback(createError(err, 'LISTNOTFOUND'));
            }
            return client.publish(_this.channelKey(), payload, callback);
          });
        };
      })(this)
    ], function(err) {
      return cb(createError(err, 'PUSHJOB'));
    });
  };

  return Worker;

})();


/* */

exports.Worker = Worker;

exports.WorkerError = WorkerError;

//# sourceMappingURL=data:application/json;base64,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QUFBO21CQUNBLE1BQU0sQ0FBQyxLQUFQLENBQWEsS0FBQyxDQUFBLE9BQUQsQ0FBQSxDQUFiLEVBQXlCLE9BQXpCLEVBQWtDLFFBQWxDLEVBRmdCO1VBQUEsQ0FBbEIsRUFERjtRQUFBLEVBQUE7TUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBRFcsRUFLWCxDQUFBLFNBQUEsS0FBQSxHQUFBO2VBQUEsU0FBQyxRQUFELEdBQUE7aUJBQ0UsS0FBQyxDQUFBLGdCQUFELENBQWtCLFNBQUMsR0FBRCxFQUFLLE1BQUwsR0FBQTtBQUNoQixZQUFBLElBQXFELEdBQXJEO0FBQUEscUJBQU8sUUFBQSxDQUFTLFdBQUEsQ0FBWSxHQUFaLEVBQWlCLGNBQWpCLENBQVQsQ0FBUCxDQUFBO2FBQUE7bUJBQ0EsTUFBTSxDQUFDLE9BQVAsQ0FBZSxLQUFDLENBQUEsVUFBRCxDQUFBLENBQWYsRUFBOEIsT0FBOUIsRUFBdUMsUUFBdkMsRUFGZ0I7VUFBQSxDQUFsQixFQURGO1FBQUEsRUFBQTtNQUFBLENBQUEsQ0FBQSxDQUFBLElBQUEsQ0FMVztLQUFiLEVBU0csU0FBQyxHQUFELEdBQUE7YUFDRCxFQUFBLENBQUcsV0FBQSxDQUFZLEdBQVosRUFBaUIsU0FBakIsQ0FBSCxFQURDO0lBQUEsQ0FUSCxFQUZPO0VBQUEsQ0E5RFQsQ0FBQTs7Z0JBQUE7O0lBVkYsQ0FBQTs7QUF1RkE7QUFBQSxLQXZGQTs7QUFBQSxPQXlGTyxDQUFDLE1BQVIsR0FBaUIsTUF6RmpCLENBQUE7O0FBQUEsT0EwRk8sQ0FBQyxXQUFSLEdBQXNCLFdBMUZ0QixDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiYXN5bmMgICA9IHJlcXVpcmUoJ2FzeW5jJylcblJlZGlzQ29ubmVjdGlvbk1hbmFnZXIgPSByZXF1aXJlKFwicmVkaXMtY29ubmVjdGlvbi1tYW5hZ2VyXCIpLlJlZGlzQ29ubmVjdGlvbk1hbmFnZXJcbmVycm9ycyA9IHJlcXVpcmUoJy4vZXJyb3JzJylcblxuY3JlYXRlRXJyb3IgPSBlcnJvcnMuY3JlYXRlRXJyb3JcbldvcmtlckVycm9yID0gZXJyb3JzLldvcmtlckVycm9yXG5FUlJfRFJZX1BPT0wgPSBlcnJvcnMuRVJSX0RSWV9QT09MXG5cblxuY2xhc3MgV29ya2VyXG4gIGNvbnN0cnVjdG9yOiAoQHVybCkgLT5cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IGNyZWF0ZSBXb3JrZXIgd2l0aCBSZWRpcyBVcmwnKSB1bmxlc3MgQHVybFxuXG4gIG5hbWU6ICgpIC0+XG4gICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBvdmVyd3JpdGUgV29ya2VyI25hbWUgaW4gc3ViY2xhc3MnKVxuXG4gICMgUmVkaXNcbiAgbGlzdEtleTogICAgKCkgLT4gXCJ3b3JrZXI6bGlzdDoje0BuYW1lKCl9XCJcbiAgY2hhbm5lbEtleTogKCkgLT4gXCJ3b3JrZXI6Y2hhbm5lbDoje0BuYW1lKCl9XCJcblxuICBvYnRhaW5MaXN0Q2xpZW50OiAgICAoZG9uZSkgLT4gUmVkaXNDb25uZWN0aW9uTWFuYWdlci5vYnRhaW5DbGllbnQgQHVybCwgJ2xpc3QnLCBkb25lXG4gIG9idGFpbkNoYW5uZWxDbGllbnQ6IChkb25lKSAtPiBSZWRpc0Nvbm5lY3Rpb25NYW5hZ2VyLm9idGFpbkNsaWVudCBAdXJsLCAnY2hhbm5lbCcsIGRvbmVcblxuICAjIEludGVybmFsXG4gIHBvcEpvYkZyb21RdWV1ZTogKGNiKSAtPlxuICAgIEBvYnRhaW5MaXN0Q2xpZW50IChlcnIsIGNsaWVudCkgPT5cbiAgICAgIHJldHVybiBjYiBjcmVhdGVFcnJvcihlcnIsICdMSVNUTk9URk9VTkQnKSBpZiBlcnJcbiAgICAgIGNsaWVudC5scG9wIEBsaXN0S2V5KCksIGNiXG5cbiAgY2hlY2tBbmRSdW5UYXNrOiAoY2IpIC0+XG4gICAgcmV0dXJuIGNiKCkgaWYgQGJ1c3lcbiAgICBAYnVzeSA9IHRydWVcbiAgICBhc3luYy5mb3JldmVyIChuZXh0KSA9PlxuICAgICAgQHBvcEpvYkZyb21RdWV1ZSAoZXJyLHRhc2spID0+XG4gICAgICAgIHJldHVybiBuZXh0KGNyZWF0ZUVycm9yKGVyciwgJ1BPUEpPQicpKSBpZiBlcnJcbiAgICAgICAgcmV0dXJuIG5leHQoRVJSX0RSWV9QT09MKSB1bmxlc3MgdGFza1xuICAgICAgICBAd29yayB0YXNrLCAoZXJyKSA9PlxuICAgICAgICAgIGlmIGVyclxuICAgICAgICAgICAgQGVycm9yIGVyciwgdGFzaywgKGVycikgLT4gbmV4dChjcmVhdGVFcnJvcihlcnIsICdSVU5UQVNLJykpXG4gICAgICAgICAgZWxzZVxuICAgICAgICAgICAgbmV4dCgpXG4gICAgLCAoZXJyKSA9PlxuICAgICAgQGJ1c3kgPSBmYWxzZVxuICAgICAgaWYgKGVyciA9PSBFUlJfRFJZX1BPT0wpXG4gICAgICAgIHJldHVybiBjYigpXG4gICAgICBlbHNlIGlmIChlcnIpXG4gICAgICAgIHJldHVybiBjYiBlcnJcblxuICAjIFN1YmNsYXNzIEFQSVxuICB3b3JrOiAoKSAtPlxuICAgIHRocm93IG5ldyBFcnJvcignWW91IG11c3Qgb3ZlcndyaXRlIFdvcmtlciN3b3JrIGluIHN1YmNsYXNzJylcblxuICBlcnJvcjogKCkgLT5cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IG92ZXJ3cml0ZSBXb3JrZXIjZXJyb3IgaW4gc3ViY2xhc3MnKVxuXG4gICMgQVBJXG4gIHdhaXRGb3JUYXNrczogKGNiKSAtPlxuICAgIEBvYnRhaW5DaGFubmVsQ2xpZW50IChlcnIsIGNsaWVudCkgPT5cbiAgICAgIHJldHVybiBjYiBjcmVhdGVFcnJvcihlcnIsICdDSEFOTkVMTk9URk9VTkQnKSBpZiBlcnJcblxuICAgICAgQGNoZWNrQW5kUnVuVGFzayAoZXJyKSAtPlxuICAgICAgICBjYiBlcnIgaWYgZXJyXG5cbiAgICAgIGNsaWVudC5vbiAnbWVzc2FnZScsIChjaGFubmVsLCBtZXNzYWdlKSA9PlxuICAgICAgICBpZiBjaGFubmVsID09IEBjaGFubmVsS2V5KClcbiAgICAgICAgICBAY2hlY2tBbmRSdW5UYXNrIChlcnIpIC0+XG4gICAgICAgICAgICBjYiBlcnIgaWYgZXJyXG5cbiAgICAgIGNsaWVudC5zdWJzY3JpYmUoQGNoYW5uZWxLZXkoKSlcblxuICAgICAgY2IoKVxuXG4gIHB1c2hKb2I6IChqb2JEaWN0LCBjYikgLT5cbiAgICBwYXlsb2FkID0gSlNPTi5zdHJpbmdpZnkoam9iRGljdClcbiAgICBhc3luYy5zZXJpZXMgW1xuICAgICAgKGNhbGxiYWNrKSA9PlxuICAgICAgICBAb2J0YWluTGlzdENsaWVudCAoZXJyLGNsaWVudCkgPT5cbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soY3JlYXRlRXJyb3IoZXJyLCAnTElTVE5PVEZPVU5EJykpIGlmIGVyclxuICAgICAgICAgIGNsaWVudC5ycHVzaChAbGlzdEtleSgpLCBwYXlsb2FkLCBjYWxsYmFjaylcbiAgICAgIChjYWxsYmFjaykgPT5cbiAgICAgICAgQG9idGFpbkxpc3RDbGllbnQgKGVycixjbGllbnQpID0+XG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrKGNyZWF0ZUVycm9yKGVyciwgJ0xJU1ROT1RGT1VORCcpKSBpZiBlcnJcbiAgICAgICAgICBjbGllbnQucHVibGlzaChAY2hhbm5lbEtleSgpLCBwYXlsb2FkLCBjYWxsYmFjaylcbiAgICBdLCAoZXJyKSAtPlxuICAgICAgY2IoY3JlYXRlRXJyb3IoZXJyLCAnUFVTSEpPQicpKVxuXG5cbiMjIyAjIyNcbiMgRVhQT1JUU1xuZXhwb3J0cy5Xb3JrZXIgPSBXb3JrZXJcbmV4cG9ydHMuV29ya2VyRXJyb3IgPSBXb3JrZXJFcnJvclxuIl19
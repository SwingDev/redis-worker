var ERR_DRY_POOL, RedisConnectionManager, Worker, WorkerError, async, createError, errors;

async = require('async');

RedisConnectionManager = require("redis-connection-manager").RedisConnectionManager;

errors = require('./errors');

createError = errors.createError;

WorkerError = errors.WorkerError;

ERR_DRY_POOL = errors.ERR_DRY_POOL;

Worker = (function() {
  function Worker(url, taskLimit) {
    this.url = url;
    this.taskLimit = taskLimit;
    if (!this.url) {
      throw new Error('You must create Worker with Redis Url');
    }
    if (!this.taskLimit) {
      this.taskLimit = 5;
    }
    this.taskNo = 0;
    this.taskClean = false;
    this.queue = async.queue((function(_this) {
      return function(task, callback) {
        return _this.checkAndRunTask(function(err) {
          if (err) {
            return callback(err);
          }
          return callback();
        });
      };
    })(this), this.taskLimit);
    this.queue.drain = (function(_this) {
      return function() {
        if (!_this.taskClean) {
          _this.taskNo++;
          return _this.queue.push(_this.taskNo, function(err) {
            if (err) {
              cb(err);
            }
          });
        }
      };
    })(this);
  }

  Worker.prototype.name = function() {
    throw new Error('You must overwrite Worker#name in subclass');
  };

  Worker.prototype.listKey = function() {
    return "worker:list:" + (this.name());
  };

  Worker.prototype.channelKey = function() {
    return "worker:channel:" + (this.name());
  };

  Worker.prototype.obtainListClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'list', done);
  };

  Worker.prototype.obtainChannelClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'channel', done);
  };

  Worker.prototype.popJobFromQueue = function(cb) {
    return this.obtainListClient((function(_this) {
      return function(err, client) {
        if (err) {
          return cb(createError(err, 'LISTNOTFOUND'));
        }
        return client.lpop(_this.listKey(), cb);
      };
    })(this));
  };

  Worker.prototype.checkAndRunTask = function(cb) {
    return this.popJobFromQueue((function(_this) {
      return function(err, task) {
        if (err) {
          return cb(createError(err, 'POPJOB'));
        }
        if (!task) {
          _this.taskClean = true;
          return cb();
        }
        return _this.work(task, function(err) {
          if (err) {
            return _this.error(err, task, function(err) {
              return cb(createError(err, 'RUNTASK'));
            });
          } else {
            return cb();
          }
        });
      };
    })(this));
  };

  Worker.prototype.work = function() {
    throw new Error('You must overwrite Worker#work in subclass');
  };

  Worker.prototype.error = function() {
    throw new Error('You must overwrite Worker#error in subclass');
  };

  Worker.prototype.waitForTasks = function(cb) {
    return this.obtainChannelClient((function(_this) {
      return function(err, client) {
        if (err) {
          return cb(createError(err, 'CHANNELNOTFOUND'));
        }
        client.llen(_this.listKey(), function(err, length) {
          var count, _i, _results;
          if (length > 0) {
            _results = [];
            for (count = _i = length; length <= 1 ? _i <= 1 : _i >= 1; count = length <= 1 ? ++_i : --_i) {
              _this.taskNo++;
              _results.push(_this.queue.push(_this.taskNo, function(err) {
                if (err) {
                  cb(err);
                }
              }));
            }
            return _results;
          }
        });
        client.on('message', function(channel, message) {
          if (channel === _this.channelKey()) {
            _this.taskClean = false;
            _this.taskNo++;
            return _this.queue.push(_this.taskNo, function(err) {
              if (err) {
                cb(err);
              }
            });
          }
        });
        client.subscribe(_this.channelKey());
        return cb();
      };
    })(this));
  };

  Worker.prototype.pushJob = function(jobDict, cb) {
    var payload;
    payload = JSON.stringify(jobDict);
    return async.series([
      (function(_this) {
        return function(callback) {
          return _this.obtainListClient(function(err, client) {
            if (err) {
              return callback(createError(err, 'LISTNOTFOUND'));
            }
            return client.rpush(_this.listKey(), payload, callback);
          });
        };
      })(this), (function(_this) {
        return function(callback) {
          return _this.obtainListClient(function(err, client) {
            if (err) {
              return callback(createError(err, 'LISTNOTFOUND'));
            }
            return client.publish(_this.channelKey(), payload, callback);
          });
        };
      })(this)
    ], function(err) {
      return cb(createError(err, 'PUSHJOB'));
    });
  };

  return Worker;

})();


/* */

exports.Worker = Worker;

exports.WorkerError = WorkerError;

//# sourceMappingURL=data:application/json;base64,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YUFBQTttQkFDQSxNQUFNLENBQUMsS0FBUCxDQUFhLEtBQUMsQ0FBQSxPQUFELENBQUEsQ0FBYixFQUF5QixPQUF6QixFQUFrQyxRQUFsQyxFQUZnQjtVQUFBLENBQWxCLEVBREY7UUFBQSxFQUFBO01BQUEsQ0FBQSxDQUFBLENBQUEsSUFBQSxDQURXLEVBS1gsQ0FBQSxTQUFBLEtBQUEsR0FBQTtlQUFBLFNBQUMsUUFBRCxHQUFBO2lCQUNFLEtBQUMsQ0FBQSxnQkFBRCxDQUFrQixTQUFDLEdBQUQsRUFBSyxNQUFMLEdBQUE7QUFDaEIsWUFBQSxJQUFxRCxHQUFyRDtBQUFBLHFCQUFPLFFBQUEsQ0FBUyxXQUFBLENBQVksR0FBWixFQUFpQixjQUFqQixDQUFULENBQVAsQ0FBQTthQUFBO21CQUNBLE1BQU0sQ0FBQyxPQUFQLENBQWUsS0FBQyxDQUFBLFVBQUQsQ0FBQSxDQUFmLEVBQThCLE9BQTlCLEVBQXVDLFFBQXZDLEVBRmdCO1VBQUEsQ0FBbEIsRUFERjtRQUFBLEVBQUE7TUFBQSxDQUFBLENBQUEsQ0FBQSxJQUFBLENBTFc7S0FBYixFQVNHLFNBQUMsR0FBRCxHQUFBO2FBQ0QsRUFBQSxDQUFHLFdBQUEsQ0FBWSxHQUFaLEVBQWlCLFNBQWpCLENBQUgsRUFEQztJQUFBLENBVEgsRUFGTztFQUFBLENBckZULENBQUE7O2dCQUFBOztJQVZGLENBQUE7O0FBOEdBO0FBQUEsS0E5R0E7O0FBQUEsT0FnSE8sQ0FBQyxNQUFSLEdBQWlCLE1BaEhqQixDQUFBOztBQUFBLE9BaUhPLENBQUMsV0FBUixHQUFzQixXQWpIdEIsQ0FBQSIsImZpbGUiOiJpbmRleC5qcyIsInNvdXJjZVJvb3QiOiIvc291cmNlLyIsInNvdXJjZXNDb250ZW50IjpbImFzeW5jICAgPSByZXF1aXJlKCdhc3luYycpXG5SZWRpc0Nvbm5lY3Rpb25NYW5hZ2VyID0gcmVxdWlyZShcInJlZGlzLWNvbm5lY3Rpb24tbWFuYWdlclwiKS5SZWRpc0Nvbm5lY3Rpb25NYW5hZ2VyXG5lcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpXG5cbmNyZWF0ZUVycm9yID0gZXJyb3JzLmNyZWF0ZUVycm9yXG5Xb3JrZXJFcnJvciA9IGVycm9ycy5Xb3JrZXJFcnJvclxuRVJSX0RSWV9QT09MID0gZXJyb3JzLkVSUl9EUllfUE9PTFxuXG5cbmNsYXNzIFdvcmtlclxuICBjb25zdHJ1Y3RvcjogKEB1cmwsIEB0YXNrTGltaXQpIC0+XG4gICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBjcmVhdGUgV29ya2VyIHdpdGggUmVkaXMgVXJsJykgdW5sZXNzIEB1cmxcbiAgICBAdGFza0xpbWl0ID0gNSB1bmxlc3MgQHRhc2tMaW1pdFxuICAgIEB0YXNrTm8gPSAwXG4gICAgQHRhc2tDbGVhbiA9IGZhbHNlXG5cbiAgICBAcXVldWUgPSBhc3luYy5xdWV1ZSgodGFzaywgY2FsbGJhY2spID0+XG4gICAgICAjIGNvbnNvbGUubG9nICdcXG5cXG5cXG50YXNrTm8nICsgdGFza1xuICAgICAgIyBjb25zb2xlLmxvZyAndGFza2xpbWl0JywgQHRhc2tMaW1pdFxuICAgICAgIyBjb25zb2xlLmxvZyAnY29uY3VyZW5jeSB2YWwnLCBAcXVldWUuY29uY3VycmVuY3lcbiAgICAgICMgY29uc29sZS5sb2cgJ251bWJlciBvZiB0YXNrcyBpbiBxdWV1ZScsIEBxdWV1ZS5sZW5ndGgoKVxuICAgICAgIyBjb25zb2xlLmxvZyAnbnVtYmVyIG9mIHRhc2tzIHJ1bm5pbmcnLCBAcXVldWUucnVubmluZygpXG4gICAgICBAY2hlY2tBbmRSdW5UYXNrIChlcnIpIC0+XG4gICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpIGlmIGVyclxuICAgICAgICBjYWxsYmFjaygpXG4gICAgLCBAdGFza0xpbWl0KTtcblxuICAgIEBxdWV1ZS5kcmFpbiA9ICgpID0+XG4gICAgICB1bmxlc3MgQHRhc2tDbGVhblxuICAgICAgICBAdGFza05vKytcbiAgICAgICAgQHF1ZXVlLnB1c2ggQHRhc2tObywgKGVycikgLT5cbiAgICAgICAgICBjYihlcnIpIGlmIGVyclxuICAgICAgICAgIHJldHVyblxuXG4gIG5hbWU6ICgpIC0+XG4gICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBvdmVyd3JpdGUgV29ya2VyI25hbWUgaW4gc3ViY2xhc3MnKVxuXG4gICMgUmVkaXNcbiAgbGlzdEtleTogICAgKCkgLT4gXCJ3b3JrZXI6bGlzdDoje0BuYW1lKCl9XCJcbiAgY2hhbm5lbEtleTogKCkgLT4gXCJ3b3JrZXI6Y2hhbm5lbDoje0BuYW1lKCl9XCJcblxuICBvYnRhaW5MaXN0Q2xpZW50OiAgICAoZG9uZSkgLT4gUmVkaXNDb25uZWN0aW9uTWFuYWdlci5vYnRhaW5DbGllbnQgQHVybCwgJ2xpc3QnLCBkb25lXG4gIG9idGFpbkNoYW5uZWxDbGllbnQ6IChkb25lKSAtPiBSZWRpc0Nvbm5lY3Rpb25NYW5hZ2VyLm9idGFpbkNsaWVudCBAdXJsLCAnY2hhbm5lbCcsIGRvbmVcblxuICAjIEludGVybmFsXG4gIHBvcEpvYkZyb21RdWV1ZTogKGNiKSAtPlxuICAgIEBvYnRhaW5MaXN0Q2xpZW50IChlcnIsIGNsaWVudCkgPT5cbiAgICAgIHJldHVybiBjYiBjcmVhdGVFcnJvcihlcnIsICdMSVNUTk9URk9VTkQnKSBpZiBlcnJcbiAgICAgIGNsaWVudC5scG9wIEBsaXN0S2V5KCksIGNiXG5cbiAgY2hlY2tBbmRSdW5UYXNrOiAoY2IpIC0+XG4gICAgQHBvcEpvYkZyb21RdWV1ZSAoZXJyLHRhc2spID0+XG4gICAgICByZXR1cm4gY2IoY3JlYXRlRXJyb3IoZXJyLCAnUE9QSk9CJykpIGlmIGVyclxuICAgICAgdW5sZXNzIHRhc2tcbiAgICAgICAgQHRhc2tDbGVhbiA9IHRydWVcbiAgICAgICAgcmV0dXJuIGNiKCkgXG4gICAgICBAd29yayB0YXNrLCAoZXJyKSA9PlxuICAgICAgICBpZiBlcnJcbiAgICAgICAgICBAZXJyb3IgZXJyLCB0YXNrLCAoZXJyKSAtPiBjYihjcmVhdGVFcnJvcihlcnIsICdSVU5UQVNLJykpXG4gICAgICAgIGVsc2VcbiAgICAgICAgICBjYigpXG5cblxuICAjIFN1YmNsYXNzIEFQSVxuICB3b3JrOiAoKSAtPlxuICAgIHRocm93IG5ldyBFcnJvcignWW91IG11c3Qgb3ZlcndyaXRlIFdvcmtlciN3b3JrIGluIHN1YmNsYXNzJylcblxuICBlcnJvcjogKCkgLT5cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IG92ZXJ3cml0ZSBXb3JrZXIjZXJyb3IgaW4gc3ViY2xhc3MnKVxuXG4gICMgQVBJXG4gIHdhaXRGb3JUYXNrczogKGNiKSAtPlxuICAgIEBvYnRhaW5DaGFubmVsQ2xpZW50IChlcnIsIGNsaWVudCkgPT5cbiAgICAgIHJldHVybiBjYiBjcmVhdGVFcnJvcihlcnIsICdDSEFOTkVMTk9URk9VTkQnKSBpZiBlcnJcblxuICAgICAgY2xpZW50LmxsZW4gQGxpc3RLZXkoKSwgKGVyciwgbGVuZ3RoKSA9PlxuICAgICAgICBpZiBsZW5ndGggPiAwXG4gICAgICAgICAgZm9yIGNvdW50IGluIFtsZW5ndGguLjFdXG4gICAgICAgICAgICBAdGFza05vKytcbiAgICAgICAgICAgIEBxdWV1ZS5wdXNoIEB0YXNrTm8sIChlcnIpIC0+XG4gICAgICAgICAgICAgIGNiKGVycikgaWYgZXJyXG4gICAgICAgICAgICAgIHJldHVyblxuXG4gICAgICBjbGllbnQub24gJ21lc3NhZ2UnLCAoY2hhbm5lbCwgbWVzc2FnZSkgPT5cbiAgICAgICAgaWYgY2hhbm5lbCA9PSBAY2hhbm5lbEtleSgpXG4gICAgICAgICAgQHRhc2tDbGVhbiA9IGZhbHNlXG4gICAgICAgICAgQHRhc2tObysrXG4gICAgICAgICAgQHF1ZXVlLnB1c2ggQHRhc2tObywgKGVycikgLT5cbiAgICAgICAgICAgIGNiKGVycikgaWYgZXJyXG4gICAgICAgICAgICByZXR1cm5cblxuICAgICAgY2xpZW50LnN1YnNjcmliZShAY2hhbm5lbEtleSgpKVxuXG4gICAgICBjYigpXG5cbiAgcHVzaEpvYjogKGpvYkRpY3QsIGNiKSAtPlxuICAgIHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShqb2JEaWN0KVxuICAgIGFzeW5jLnNlcmllcyBbXG4gICAgICAoY2FsbGJhY2spID0+XG4gICAgICAgIEBvYnRhaW5MaXN0Q2xpZW50IChlcnIsY2xpZW50KSA9PlxuICAgICAgICAgIHJldHVybiBjYWxsYmFjayhjcmVhdGVFcnJvcihlcnIsICdMSVNUTk9URk9VTkQnKSkgaWYgZXJyXG4gICAgICAgICAgY2xpZW50LnJwdXNoKEBsaXN0S2V5KCksIHBheWxvYWQsIGNhbGxiYWNrKVxuICAgICAgKGNhbGxiYWNrKSA9PlxuICAgICAgICBAb2J0YWluTGlzdENsaWVudCAoZXJyLGNsaWVudCkgPT5cbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soY3JlYXRlRXJyb3IoZXJyLCAnTElTVE5PVEZPVU5EJykpIGlmIGVyclxuICAgICAgICAgIGNsaWVudC5wdWJsaXNoKEBjaGFubmVsS2V5KCksIHBheWxvYWQsIGNhbGxiYWNrKVxuICAgIF0sIChlcnIpIC0+XG4gICAgICBjYihjcmVhdGVFcnJvcihlcnIsICdQVVNISk9CJykpXG5cblxuIyMjICMjI1xuIyBFWFBPUlRTXG5leHBvcnRzLldvcmtlciA9IFdvcmtlclxuZXhwb3J0cy5Xb3JrZXJFcnJvciA9IFdvcmtlckVycm9yXG4iXX0=
var ERR_DRY_POOL, RedisConnectionManager, Worker, WorkerError, async, createError, errors;

async = require('async');

RedisConnectionManager = require("redis-connection-manager").RedisConnectionManager;

errors = require('./errors');

createError = errors.createError;

WorkerError = errors.WorkerError;

ERR_DRY_POOL = errors.ERR_DRY_POOL;

Worker = (function() {
  function Worker(url, taskLimit) {
    this.url = url;
    this.taskLimit = taskLimit;
    if (!this.url) {
      throw new Error('You must create Worker with Redis Url');
    }
    if (!this.taskLimit) {
      this.taskLimit = 5;
    }
    this.taskNo = 0;
    this.taskClean = false;
    this.errInQueue = false;
    this.queue = async.queue((function(_this) {
      return function(task, callback) {
        return _this.checkAndRunTask(function(err) {
          if (err) {
            this.errInQueue = true;
            console.error('Error at worker queue', err);
            setTimeout(function() {
              return process.exit(-1);
            }, 15000);
            return callback(err);
          }
          return callback();
        });
      };
    })(this), this.taskLimit);
    this.queue.drain = (function(_this) {
      return function() {
        if (!_this.taskClean && !_this.errInQueue) {
          _this.taskNo++;
          return _this.queue.push(_this.taskNo, function(err) {
            if (err) {
              cb(err);
            }
          });
        }
      };
    })(this);
  }

  Worker.prototype.name = function() {
    throw new Error('You must overwrite Worker#name in subclass');
  };

  Worker.prototype.listKey = function() {
    return "worker:list:" + (this.name());
  };

  Worker.prototype.channelKey = function() {
    return "worker:channel:" + (this.name());
  };

  Worker.prototype.obtainListClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'list', done);
  };

  Worker.prototype.obtainChannelClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'channel', done);
  };

  Worker.prototype.popJobFromQueue = function(cb) {
    return this.obtainListClient((function(_this) {
      return function(err, client) {
        if (err) {
          return cb(createError(err, 'LISTNOTFOUND'));
        }
        return client.lpop(_this.listKey(), cb);
      };
    })(this));
  };

  Worker.prototype.checkAndRunTask = function(cb) {
    return this.popJobFromQueue((function(_this) {
      return function(err, task) {
        if (err) {
          return cb(createError(err, 'POPJOB'));
        }
        if (!task) {
          _this.taskClean = true;
          return cb();
        }
        return _this.work(task, function(err) {
          if (err) {
            return _this.error(err, task, function(err) {
              return cb(createError(err, 'RUNTASK'));
            });
          } else {
            return cb();
          }
        });
      };
    })(this));
  };

  Worker.prototype.work = function() {
    throw new Error('You must overwrite Worker#work in subclass');
  };

  Worker.prototype.error = function() {
    throw new Error('You must overwrite Worker#error in subclass');
  };

  Worker.prototype.waitForTasks = function(cb) {
    return this.obtainChannelClient((function(_this) {
      return function(err, client) {
        if (err) {
          return cb(createError(err, 'CHANNELNOTFOUND'));
        }
        client.llen(_this.listKey(), function(err, length) {
          var count, _i, _results;
          if (length > 0) {
            _results = [];
            for (count = _i = length; length <= 1 ? _i <= 1 : _i >= 1; count = length <= 1 ? ++_i : --_i) {
              _this.taskNo++;
              _results.push(_this.queue.push(_this.taskNo, function(err) {
                if (err) {
                  cb(err);
                }
              }));
            }
            return _results;
          }
        });
        client.on('message', function(channel, message) {
          if (channel === _this.channelKey()) {
            if (!_this.errInQueue) {
              _this.taskClean = false;
              _this.taskNo++;
              return _this.queue.push(_this.taskNo, function(err) {
                if (err) {
                  cb(err);
                }
              });
            }
          }
        });
        client.subscribe(_this.channelKey());
        return cb();
      };
    })(this));
  };

  Worker.prototype.pushJob = function(jobDict, cb) {
    var payload;
    payload = JSON.stringify(jobDict);
    return async.series([
      (function(_this) {
        return function(callback) {
          return _this.obtainListClient(function(err, client) {
            if (err) {
              return callback(createError(err, 'LISTNOTFOUND'));
            }
            return client.rpush(_this.listKey(), payload, callback);
          });
        };
      })(this), (function(_this) {
        return function(callback) {
          return _this.obtainListClient(function(err, client) {
            if (err) {
              return callback(createError(err, 'LISTNOTFOUND'));
            }
            return client.publish(_this.channelKey(), payload, callback);
          });
        };
      })(this)
    ], function(err) {
      return cb(createError(err, 'PUSHJOB'));
    });
  };

  return Worker;

})();


/* */

exports.Worker = Worker;

exports.WorkerError = WorkerError;

//# sourceMappingURL=data:application/json;base64,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QUFBOztBQXNIQTtBQUFBLEtBdEhBOztBQUFBLE9Bd0hPLENBQUMsTUFBUixHQUFpQixNQXhIakIsQ0FBQTs7QUFBQSxPQXlITyxDQUFDLFdBQVIsR0FBc0IsV0F6SHRCLENBQUEiLCJmaWxlIjoibGliL2luZGV4LmpzIiwic291cmNlUm9vdCI6Ii9zb3VyY2UvIiwic291cmNlc0NvbnRlbnQiOlsiYXN5bmMgICA9IHJlcXVpcmUoJ2FzeW5jJylcblJlZGlzQ29ubmVjdGlvbk1hbmFnZXIgPSByZXF1aXJlKFwicmVkaXMtY29ubmVjdGlvbi1tYW5hZ2VyXCIpLlJlZGlzQ29ubmVjdGlvbk1hbmFnZXJcbmVycm9ycyA9IHJlcXVpcmUoJy4vZXJyb3JzJylcblxuY3JlYXRlRXJyb3IgPSBlcnJvcnMuY3JlYXRlRXJyb3JcbldvcmtlckVycm9yID0gZXJyb3JzLldvcmtlckVycm9yXG5FUlJfRFJZX1BPT0wgPSBlcnJvcnMuRVJSX0RSWV9QT09MXG5cblxuY2xhc3MgV29ya2VyXG4gIGNvbnN0cnVjdG9yOiAoQHVybCwgQHRhc2tMaW1pdCkgLT5cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IGNyZWF0ZSBXb3JrZXIgd2l0aCBSZWRpcyBVcmwnKSB1bmxlc3MgQHVybFxuICAgIEB0YXNrTGltaXQgPSA1IHVubGVzcyBAdGFza0xpbWl0XG4gICAgQHRhc2tObyA9IDBcbiAgICBAdGFza0NsZWFuID0gZmFsc2VcbiAgICBAZXJySW5RdWV1ZSA9IGZhbHNlXG5cbiAgICBAcXVldWUgPSBhc3luYy5xdWV1ZSgodGFzaywgY2FsbGJhY2spID0+XG4gICAgICAjIGNvbnNvbGUubG9nICdcXG5cXG5cXG50YXNrTm8nICsgdGFza1xuICAgICAgIyBjb25zb2xlLmxvZyAndGFza2xpbWl0JywgQHRhc2tMaW1pdFxuICAgICAgIyBjb25zb2xlLmxvZyAnY29uY3VyZW5jeSB2YWwnLCBAcXVldWUuY29uY3VycmVuY3lcbiAgICAgICMgY29uc29sZS5sb2cgJ251bWJlciBvZiB0YXNrcyBpbiBxdWV1ZScsIEBxdWV1ZS5sZW5ndGgoKVxuICAgICAgIyBjb25zb2xlLmxvZyAnbnVtYmVyIG9mIHRhc2tzIHJ1bm5pbmcnLCBAcXVldWUucnVubmluZygpXG4gICAgICBAY2hlY2tBbmRSdW5UYXNrIChlcnIpIC0+XG4gICAgICAgIGlmIGVyclxuICAgICAgICAgIEBlcnJJblF1ZXVlID0gdHJ1ZVxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IgJ0Vycm9yIGF0IHdvcmtlciBxdWV1ZScsIGVyclxuICAgICAgICAgIHNldFRpbWVvdXQoKCkgLT5cbiAgICAgICAgICAgIHByb2Nlc3MuZXhpdCgtMSlcbiAgICAgICAgICAsIDE1MDAwKVxuICAgICAgICAgIHJldHVybiBjYWxsYmFjayhlcnIpXG4gICAgICAgIGNhbGxiYWNrKClcbiAgICAsIEB0YXNrTGltaXQpXG5cbiAgICBAcXVldWUuZHJhaW4gPSAoKSA9PlxuICAgICAgaWYgbm90IEB0YXNrQ2xlYW4gYW5kIG5vdCBAZXJySW5RdWV1ZVxuICAgICAgICBAdGFza05vKytcbiAgICAgICAgQHF1ZXVlLnB1c2ggQHRhc2tObywgKGVycikgLT5cbiAgICAgICAgICBjYihlcnIpIGlmIGVyclxuICAgICAgICAgIHJldHVyblxuXG4gIG5hbWU6ICgpIC0+XG4gICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBvdmVyd3JpdGUgV29ya2VyI25hbWUgaW4gc3ViY2xhc3MnKVxuXG4gICMgUmVkaXNcbiAgbGlzdEtleTogICAgKCkgLT4gXCJ3b3JrZXI6bGlzdDoje0BuYW1lKCl9XCJcbiAgY2hhbm5lbEtleTogKCkgLT4gXCJ3b3JrZXI6Y2hhbm5lbDoje0BuYW1lKCl9XCJcblxuICBvYnRhaW5MaXN0Q2xpZW50OiAgICAoZG9uZSkgLT4gUmVkaXNDb25uZWN0aW9uTWFuYWdlci5vYnRhaW5DbGllbnQgQHVybCwgJ2xpc3QnLCBkb25lXG4gIG9idGFpbkNoYW5uZWxDbGllbnQ6IChkb25lKSAtPiBSZWRpc0Nvbm5lY3Rpb25NYW5hZ2VyLm9idGFpbkNsaWVudCBAdXJsLCAnY2hhbm5lbCcsIGRvbmVcblxuICAjIEludGVybmFsXG4gIHBvcEpvYkZyb21RdWV1ZTogKGNiKSAtPlxuICAgIEBvYnRhaW5MaXN0Q2xpZW50IChlcnIsIGNsaWVudCkgPT5cbiAgICAgIHJldHVybiBjYiBjcmVhdGVFcnJvcihlcnIsICdMSVNUTk9URk9VTkQnKSBpZiBlcnJcbiAgICAgIGNsaWVudC5scG9wIEBsaXN0S2V5KCksIGNiXG5cbiAgY2hlY2tBbmRSdW5UYXNrOiAoY2IpIC0+XG4gICAgQHBvcEpvYkZyb21RdWV1ZSAoZXJyLHRhc2spID0+XG4gICAgICByZXR1cm4gY2IoY3JlYXRlRXJyb3IoZXJyLCAnUE9QSk9CJykpIGlmIGVyclxuICAgICAgdW5sZXNzIHRhc2tcbiAgICAgICAgQHRhc2tDbGVhbiA9IHRydWVcbiAgICAgICAgcmV0dXJuIGNiKClcbiAgICAgIEB3b3JrIHRhc2ssIChlcnIpID0+XG4gICAgICAgIGlmIGVyclxuICAgICAgICAgIEBlcnJvciBlcnIsIHRhc2ssIChlcnIpIC0+IGNiKGNyZWF0ZUVycm9yKGVyciwgJ1JVTlRBU0snKSlcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGNiKClcblxuXG4gICMgU3ViY2xhc3MgQVBJXG4gIHdvcms6ICgpIC0+XG4gICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBvdmVyd3JpdGUgV29ya2VyI3dvcmsgaW4gc3ViY2xhc3MnKVxuXG4gIGVycm9yOiAoKSAtPlxuICAgIHRocm93IG5ldyBFcnJvcignWW91IG11c3Qgb3ZlcndyaXRlIFdvcmtlciNlcnJvciBpbiBzdWJjbGFzcycpXG5cbiAgIyBBUElcbiAgd2FpdEZvclRhc2tzOiAoY2IpIC0+XG4gICAgQG9idGFpbkNoYW5uZWxDbGllbnQgKGVyciwgY2xpZW50KSA9PlxuICAgICAgcmV0dXJuIGNiIGNyZWF0ZUVycm9yKGVyciwgJ0NIQU5ORUxOT1RGT1VORCcpIGlmIGVyclxuXG4gICAgICBjbGllbnQubGxlbiBAbGlzdEtleSgpLCAoZXJyLCBsZW5ndGgpID0+XG4gICAgICAgIGlmIGxlbmd0aCA+IDBcbiAgICAgICAgICBmb3IgY291bnQgaW4gW2xlbmd0aC4uMV1cbiAgICAgICAgICAgIEB0YXNrTm8rK1xuICAgICAgICAgICAgQHF1ZXVlLnB1c2ggQHRhc2tObywgKGVycikgLT5cbiAgICAgICAgICAgICAgY2IoZXJyKSBpZiBlcnJcbiAgICAgICAgICAgICAgcmV0dXJuXG5cbiAgICAgIGNsaWVudC5vbiAnbWVzc2FnZScsIChjaGFubmVsLCBtZXNzYWdlKSA9PlxuICAgICAgICBpZiBjaGFubmVsID09IEBjaGFubmVsS2V5KClcbiAgICAgICAgICB1bmxlc3MgQGVyckluUXVldWVcbiAgICAgICAgICAgIEB0YXNrQ2xlYW4gPSBmYWxzZVxuICAgICAgICAgICAgQHRhc2tObysrXG4gICAgICAgICAgICBAcXVldWUucHVzaCBAdGFza05vLCAoZXJyKSAtPlxuICAgICAgICAgICAgICBjYihlcnIpIGlmIGVyclxuICAgICAgICAgICAgICByZXR1cm5cblxuICAgICAgY2xpZW50LnN1YnNjcmliZShAY2hhbm5lbEtleSgpKVxuXG4gICAgICBjYigpXG5cbiAgcHVzaEpvYjogKGpvYkRpY3QsIGNiKSAtPlxuICAgIHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShqb2JEaWN0KVxuICAgIGFzeW5jLnNlcmllcyBbXG4gICAgICAoY2FsbGJhY2spID0+XG4gICAgICAgIEBvYnRhaW5MaXN0Q2xpZW50IChlcnIsY2xpZW50KSA9PlxuICAgICAgICAgIHJldHVybiBjYWxsYmFjayhjcmVhdGVFcnJvcihlcnIsICdMSVNUTk9URk9VTkQnKSkgaWYgZXJyXG4gICAgICAgICAgY2xpZW50LnJwdXNoKEBsaXN0S2V5KCksIHBheWxvYWQsIGNhbGxiYWNrKVxuICAgICAgKGNhbGxiYWNrKSA9PlxuICAgICAgICBAb2J0YWluTGlzdENsaWVudCAoZXJyLGNsaWVudCkgPT5cbiAgICAgICAgICByZXR1cm4gY2FsbGJhY2soY3JlYXRlRXJyb3IoZXJyLCAnTElTVE5PVEZPVU5EJykpIGlmIGVyclxuICAgICAgICAgIGNsaWVudC5wdWJsaXNoKEBjaGFubmVsS2V5KCksIHBheWxvYWQsIGNhbGxiYWNrKVxuICAgIF0sIChlcnIpIC0+XG4gICAgICBjYihjcmVhdGVFcnJvcihlcnIsICdQVVNISk9CJykpXG5cblxuIyMjICMjI1xuIyBFWFBPUlRTXG5leHBvcnRzLldvcmtlciA9IFdvcmtlclxuZXhwb3J0cy5Xb3JrZXJFcnJvciA9IFdvcmtlckVycm9yXG4iXX0=
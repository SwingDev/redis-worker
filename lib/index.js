var ERR_DRY_POOL, RedisConnectionManager, Worker, WorkerError, _, async, createError, domain, errors, moment,
  bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

_ = require('lodash');

domain = require('domain');

async = require('async');

moment = require('moment');

RedisConnectionManager = require("redis-connection-manager").RedisConnectionManager;

errors = require('./errors');

createError = errors.createError;

WorkerError = errors.WorkerError;

ERR_DRY_POOL = errors.ERR_DRY_POOL;

Worker = (function() {
  Worker.prototype.gracefulShutdownTimeout = 15000;

  Worker.prototype.tasksRunning = 0;

  Worker.prototype.incRunningTasks = function() {
    return this.tasksRunning += 1;
  };

  Worker.prototype.decRunningTasks = function() {
    this.tasksRunning -= 1;
    if (!this.tasksRunning) {
      if (this.drainCallback != null) {
        return this.drainCallback();
      }
    }
  };

  function Worker(options) {
    this.handleErrorTasks = bind(this.handleErrorTasks, this);
    this.handleTaskDomainError = bind(this.handleTaskDomainError, this);
    this.decRunningTasks = bind(this.decRunningTasks, this);
    this.incRunningTasks = bind(this.incRunningTasks, this);
    this.url = options.url, this.taskLimit = options.taskLimit, this.retryTasks = options.retryTasks, this.retryPopTasksInterval = options.retryPopTasksInterval, this.backoffInterval = options.backoffInterval, this.maxRetries = options.maxRetries;
    if (!this.url) {
      throw new Error('You must create Worker with Redis Url');
    }
    if (this.taskLimit == null) {
      this.taskLimit = 2;
    }
    if (this.retryTasks == null) {
      this.retryTasks = false;
    }
    if (this.retryPopTasksInterval == null) {
      this.retryPopTasksInterval = 10 * 1000;
    }
    if (this.backoffInterval == null) {
      this.backoffInterval = 30 * 1000;
    }
    if (this.maxRetries == null) {
      this.maxRetries = 3;
    }
    this.taskNo = 1;
    this.redisQueueEmpty = false;
    this.shuttingDown = false;
    this.workerDomain = domain.create();
    this.workerDomain.on('error', (function(_this) {
      return function(err) {
        return _this.handleTaskDomainError(err);
      };
    })(this));
    this.queue = async.queue((function(_this) {
      return function(task, callback) {
        _this.workerDomain.enter();
        process.nextTick(function() {
          return _this.checkAndRunTask(function(err) {
            if (err) {
              console.error(err);
            }
            callback(null);
            return _this._fetchJobFromRedisToQueue();
          });
        });
        return _this.workerDomain.exit();
      };
    })(this), this.taskLimit);
  }

  Worker.prototype.name = function() {
    throw new Error('You must overwrite Worker#name in subclass');
  };

  Worker.prototype.listKey = function() {
    return "worker:list:" + (this.name());
  };

  Worker.prototype.errorsSetKey = function() {
    return "worker:errors:" + (this.name());
  };

  Worker.prototype.channelKey = function() {
    return "worker:channel:" + (this.name());
  };

  Worker.prototype.obtainListClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'list', done);
  };

  Worker.prototype.obtainChannelClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'channel', done);
  };

  Worker.prototype.obtainErrorsSetClient = function(done) {
    return RedisConnectionManager.obtainClient(this.url, 'errors', done);
  };

  Worker.prototype.popErrJobFromQueue = function(cb) {
    return this.obtainErrorsSetClient((function(_this) {
      return function(err, client) {
        var timestamp;
        if (err) {
          return cb(createError(err, 'ERRSETNOTFOUND'));
        }
        timestamp = moment.utc().unix();
        return client.zrangebyscore(_this.errorsSetKey(), 0, timestamp, function(err, tasks) {
          if (err) {
            return cb(createError(err));
          }
          if (!(tasks || tasks.length)) {
            return cb(null);
          }
          return client.zremrangebyscore(_this.errorsSetKey(), 0, timestamp, function(err) {
            var asyncTasks;
            if (err) {
              return cb(createError(err));
            }
            asyncTasks = _.map(tasks, function(task) {
              return function(next) {
                return _this.pushJob(JSON.parse(task), next);
              };
            });
            return async.parallel(asyncTasks, cb);
          });
        });
      };
    })(this));
  };

  Worker.prototype.popJobFromQueue = function(cb) {
    return this.obtainListClient((function(_this) {
      return function(err, client) {
        if (err) {
          return cb(createError(err, 'LISTNOTFOUND'));
        }
        return client.lpop(_this.listKey(), cb);
      };
    })(this));
  };

  Worker.prototype.checkAndRunTask = function(cb) {
    return this.popJobFromQueue((function(_this) {
      return function(err, task) {
        if (err) {
          return cb(createError(err, 'POPJOB'));
        }
        if (!task) {
          _this.redisQueueEmpty = true;
          return cb();
        }
        _this.redisQueueEmpty = false;
        _this.incRunningTasks();
        return _this.work(task, function(taskErr) {
          _this.decRunningTasks();
          if (!taskErr) {
            return cb();
          }
          return _this.error(taskErr, task, function(taskErr) {
            if (!taskErr) {
              return cb(null);
            }
            return _this.pushErrorJob(task, function(err) {
              if (err) {
                return cb(err);
              }
              if (taskErr) {
                return cb(createError(taskErr, 'RUNTASK'));
              }
              return cb(null);
            });
          });
        });
      };
    })(this));
  };

  Worker.prototype.work = function() {
    throw new Error('You must overwrite Worker#work in subclass');
  };

  Worker.prototype.error = function() {
    throw new Error('You must overwrite Worker#error in subclass');
  };

  Worker.prototype.handleTaskDomainError = function(err) {
    var postWorkHook;
    console.error("Detected an unknown error <" + err + ">, shutting down after this cycle or in " + (this.gracefulShutdownTimeout / 1000.0) + " seconds.");
    console.error(err.stack);
    if (!this.shuttingDown) {
      this.shuttingDown = true;
      postWorkHook = (function(_this) {
        return function() {
          if (!_this.shutDown) {
            console.warn("Post work, shutting down.");
            _this.workerDomain.dispose();
            process.exit(-1);
          }
          return _this.shutDown = true;
        };
      })(this);
      this.drainCallback = postWorkHook;
      setTimeout(postWorkHook, this.gracefulShutdownTimeout);
    }
    return this.decRunningTasks();
  };

  Worker.prototype.waitForTasks = function(cb) {
    return this.obtainChannelClient((function(_this) {
      return function(err, channel_client) {
        if (err) {
          return cb(createError(err, 'CHANNELNOTFOUND'));
        }
        _this.obtainListClient(function(err, list_client) {
          return list_client.llen(_this.listKey(), function(err, length) {
            var i, idx, prequeuedTasksNo, ref, results;
            prequeuedTasksNo = Math.max(1, Math.min(length, _this.taskLimit));
            if (length) {
              results = [];
              for (idx = i = 1, ref = prequeuedTasksNo; 1 <= ref ? i <= ref : i >= ref; idx = 1 <= ref ? ++i : --i) {
                results.push(_this._fetchJobFromRedisToQueue());
              }
              return results;
            }
          });
        });
        if (_this.retryTasks) {
          setInterval(_this.handleErrorTasks, _this.retryPopTasksInterval);
        }
        channel_client.on('message', function(channel, message) {
          if (channel === _this.channelKey()) {
            if (!_this._canTakeNewTasks()) {
              return;
            }
            return _this._fetchJobFromRedisToQueue(true);
          }
        });
        channel_client.subscribe(_this.channelKey());
        return cb();
      };
    })(this));
  };

  Worker.prototype.handleErrorTasks = function() {
    return this.popErrJobFromQueue(function(err) {
      if (err) {
        return console.error(err);
      }
    });
  };

  Worker.prototype.pushErrorJob = function(payload, cb) {
    var jobDict;
    if (!this.retryTasks) {
      return cb(null);
    }
    jobDict = JSON.parse(payload);
    if (jobDict.times_retried == null) {
      jobDict['times_retried'] = -1;
    }
    jobDict.times_retried++;
    if (jobDict.times_retried >= this.maxRetries) {
      return cb(null);
    }
    payload = JSON.stringify(jobDict);
    return async.series([
      (function(_this) {
        return function(next) {
          return _this.obtainErrorsSetClient(function(err, client) {
            if (err) {
              return next(createError(err, 'ERRSETNOTFOUND'));
            }
            return client.zadd(_this.errorsSetKey(), moment.utc().add(_this._calculateBackoff(jobDict.times_retried), 'ms').unix(), payload, next);
          });
        };
      })(this), (function(_this) {
        return function(next) {
          return _this.obtainErrorsSetClient(function(err, client) {
            if (err) {
              return next(createError(err, 'ERRSETNOTFOUND'));
            }
            return client.publish(_this.channelKey, payload, next);
          });
        };
      })(this)
    ], function(err) {
      if (err) {
        return cb(createError(err, 'PUSHERRJOB'));
      }
      return cb(null);
    });
  };

  Worker.prototype.pushJob = function(jobDict, cb) {
    var payload;
    payload = JSON.stringify(jobDict);
    return async.series([
      (function(_this) {
        return function(callback) {
          return _this.obtainListClient(function(err, client) {
            if (err) {
              return callback(createError(err, 'LISTNOTFOUND'));
            }
            return client.rpush(_this.listKey(), payload, callback);
          });
        };
      })(this), (function(_this) {
        return function(callback) {
          return _this.obtainListClient(function(err, client) {
            if (err) {
              return callback(createError(err, 'LISTNOTFOUND'));
            }
            return client.publish(_this.channelKey(), payload, callback);
          });
        };
      })(this)
    ], function(err) {
      if (err) {
        return cb(createError(err, 'PUSHJOB'));
      }
      return cb(null);
    });
  };

  Worker.prototype._canTakeNewTasks = function() {
    return this.queue.running() + this.queue.length() < this.taskLimit;
  };

  Worker.prototype._fetchJobFromRedisToQueue = function(force) {
    var tmpTaskNo;
    if ((!this.redisQueueEmpty || force) && !this.shuttingDown) {
      tmpTaskNo = this.taskNo;
      this.queue.push(this.taskNo, function(err) {});
      return this.taskNo++;
    }
  };

  Worker.prototype._calculateBackoff = function(numRetries) {
    var randMultiplier;
    randMultiplier = Math.random() * (Math.pow(2, numRetries + 2) - 1);
    if (numRetries === 0) {
      randMultiplier = 1;
    }
    return (this.backoffInterval * randMultiplier).toFixed(2);
  };

  return Worker;

})();


/* */

exports.Worker = Worker;

exports.WorkerError = WorkerError;

//# sourceMappingURL=data:application/json;base64,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QixVQUFBLEtBQWMsQ0FBcEM7QUFBQSxNQUFBLGNBQUEsR0FBaUIsQ0FBakIsQ0FBQTtLQURBO1dBRUEsQ0FBQyxJQUFDLENBQUEsZUFBRCxHQUFtQixjQUFwQixDQUFtQyxDQUFDLE9BQXBDLENBQTRDLENBQTVDLEVBSmlCO0VBQUEsQ0FsTm5CLENBQUE7O2dCQUFBOztJQWZGLENBQUE7O0FBd09BO0FBQUEsS0F4T0E7O0FBQUEsT0EwT08sQ0FBQyxNQUFSLEdBQWlCLE1BMU9qQixDQUFBOztBQUFBLE9BMk9PLENBQUMsV0FBUixHQUFzQixXQTNPdEIsQ0FBQSIsImZpbGUiOiJsaWIvaW5kZXguanMiLCJzb3VyY2VSb290IjoiL3NvdXJjZS8iLCJzb3VyY2VzQ29udGVudCI6WyJfICAgICAgID0gcmVxdWlyZSgnbG9kYXNoJylcbmRvbWFpbiAgPSByZXF1aXJlKCdkb21haW4nKVxuYXN5bmMgICA9IHJlcXVpcmUoJ2FzeW5jJylcbm1vbWVudCAgPSByZXF1aXJlKCdtb21lbnQnKVxuXG5SZWRpc0Nvbm5lY3Rpb25NYW5hZ2VyID0gcmVxdWlyZShcInJlZGlzLWNvbm5lY3Rpb24tbWFuYWdlclwiKS5SZWRpc0Nvbm5lY3Rpb25NYW5hZ2VyXG5lcnJvcnMgPSByZXF1aXJlKCcuL2Vycm9ycycpXG5cbmNyZWF0ZUVycm9yID0gZXJyb3JzLmNyZWF0ZUVycm9yXG5Xb3JrZXJFcnJvciA9IGVycm9ycy5Xb3JrZXJFcnJvclxuRVJSX0RSWV9QT09MID0gZXJyb3JzLkVSUl9EUllfUE9PTFxuXG5cbmNsYXNzIFdvcmtlclxuXG4gIGdyYWNlZnVsU2h1dGRvd25UaW1lb3V0OiAxNTAwMFxuICB0YXNrc1J1bm5pbmc6IDBcblxuICBpbmNSdW5uaW5nVGFza3M6ICgpID0+XG4gICAgQHRhc2tzUnVubmluZyArPSAxXG5cbiAgZGVjUnVubmluZ1Rhc2tzOiAoKSA9PlxuICAgIEB0YXNrc1J1bm5pbmcgLT0gMVxuICAgIHVubGVzcyBAdGFza3NSdW5uaW5nXG4gICAgICBAZHJhaW5DYWxsYmFjaygpIGlmIEBkcmFpbkNhbGxiYWNrP1xuXG4gIGNvbnN0cnVjdG9yOiAob3B0aW9ucykgLT5cbiAgICB7QHVybCwgQHRhc2tMaW1pdCwgQHJldHJ5VGFza3MsIEByZXRyeVBvcFRhc2tzSW50ZXJ2YWwsIEBiYWNrb2ZmSW50ZXJ2YWwsIEBtYXhSZXRyaWVzfSA9IG9wdGlvbnNcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IGNyZWF0ZSBXb3JrZXIgd2l0aCBSZWRpcyBVcmwnKSB1bmxlc3MgQHVybFxuICAgIEB0YXNrTGltaXQgID89IDJcbiAgICBAcmV0cnlUYXNrcyA/PSBmYWxzZVxuICAgIEByZXRyeVBvcFRhc2tzSW50ZXJ2YWwgPz0gMTAqMTAwMFxuICAgIEBiYWNrb2ZmSW50ZXJ2YWwgPz0gMzAqMTAwMFxuICAgIEBtYXhSZXRyaWVzID89IDNcbiAgICBAdGFza05vID0gMVxuICAgIEByZWRpc1F1ZXVlRW1wdHkgPSBmYWxzZVxuICAgIEBzaHV0dGluZ0Rvd24gPSBmYWxzZVxuXG4gICAgQHdvcmtlckRvbWFpbiA9IGRvbWFpbi5jcmVhdGUoKVxuXG4gICAgQHdvcmtlckRvbWFpbi5vbiAnZXJyb3InLCAoZXJyKSA9PlxuICAgICAgQGhhbmRsZVRhc2tEb21haW5FcnJvciBlcnJcblxuICAgIEBxdWV1ZSA9IGFzeW5jLnF1ZXVlKCh0YXNrLCBjYWxsYmFjaykgPT5cbiAgICAgICMgY29uc29sZS5sb2cgJ1xcbj4+Pj4+IFFVRVVFJ1xuICAgICAgIyBjb25zb2xlLmxvZyAnPj4+Pj4gdGFza2xpbWl0JywgQHRhc2tMaW1pdFxuICAgICAgIyBjb25zb2xlLmxvZyAnPj4+Pj4gY29uY3VyZW5jeSB2YWwnLCBAcXVldWUuY29uY3VycmVuY3lcbiAgICAgICMgY29uc29sZS5sb2cgJz4+Pj4+IG51bWJlciBvZiB0YXNrcyBpbiBxdWV1ZScsIEBxdWV1ZS5sZW5ndGgoKVxuICAgICAgIyBjb25zb2xlLmxvZyAnPj4+Pj4gbnVtYmVyIG9mIHRhc2tzIHJ1bm5pbmcnLCBAcXVldWUucnVubmluZygpLCAnXFxuJ1xuXG4gICAgICBAd29ya2VyRG9tYWluLmVudGVyKClcbiAgICAgIHByb2Nlc3MubmV4dFRpY2sgKCkgPT5cbiAgICAgICAgQGNoZWNrQW5kUnVuVGFzayAoZXJyKSA9PlxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IgZXJyIGlmIGVyclxuXG4gICAgICAgICAgY2FsbGJhY2sgbnVsbFxuICAgICAgICAgIEBfZmV0Y2hKb2JGcm9tUmVkaXNUb1F1ZXVlKClcbiAgICAgIEB3b3JrZXJEb21haW4uZXhpdCgpXG5cbiAgICAsIEB0YXNrTGltaXQpXG5cbiAgbmFtZTogKCkgLT5cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IG92ZXJ3cml0ZSBXb3JrZXIjbmFtZSBpbiBzdWJjbGFzcycpXG5cbiAgIyBSZWRpc1xuICBsaXN0S2V5OiAgICAgICgpIC0+IFwid29ya2VyOmxpc3Q6I3tAbmFtZSgpfVwiXG4gIGVycm9yc1NldEtleTogKCkgLT4gXCJ3b3JrZXI6ZXJyb3JzOiN7QG5hbWUoKX1cIlxuICBjaGFubmVsS2V5OiAgICgpIC0+IFwid29ya2VyOmNoYW5uZWw6I3tAbmFtZSgpfVwiXG5cbiAgb2J0YWluTGlzdENsaWVudDogICAgICAgKGRvbmUpIC0+IFJlZGlzQ29ubmVjdGlvbk1hbmFnZXIub2J0YWluQ2xpZW50IEB1cmwsICdsaXN0JywgZG9uZVxuICBvYnRhaW5DaGFubmVsQ2xpZW50OiAgICAoZG9uZSkgLT4gUmVkaXNDb25uZWN0aW9uTWFuYWdlci5vYnRhaW5DbGllbnQgQHVybCwgJ2NoYW5uZWwnLCBkb25lXG4gIG9idGFpbkVycm9yc1NldENsaWVudDogIChkb25lKSAtPiBSZWRpc0Nvbm5lY3Rpb25NYW5hZ2VyLm9idGFpbkNsaWVudCBAdXJsLCAnZXJyb3JzJywgZG9uZVxuXG4gICMgSW50ZXJuYWxcbiAgcG9wRXJySm9iRnJvbVF1ZXVlOiAoY2IpIC0+XG4gICAgQG9idGFpbkVycm9yc1NldENsaWVudCAoZXJyLCBjbGllbnQpID0+XG4gICAgICByZXR1cm4gY2IgY3JlYXRlRXJyb3IoZXJyLCAnRVJSU0VUTk9URk9VTkQnKSBpZiBlcnJcbiAgICAgIHRpbWVzdGFtcCA9IG1vbWVudC51dGMoKS51bml4KClcbiAgICAgIGNsaWVudC56cmFuZ2VieXNjb3JlIEBlcnJvcnNTZXRLZXkoKSwgMCwgdGltZXN0YW1wLCAoZXJyLCB0YXNrcykgPT5cbiAgICAgICAgcmV0dXJuIGNiIGNyZWF0ZUVycm9yKGVycikgaWYgZXJyXG4gICAgICAgIHJldHVybiBjYiBudWxsIHVubGVzcyB0YXNrcyBvciB0YXNrcy5sZW5ndGhcbiAgICAgICAgY2xpZW50LnpyZW1yYW5nZWJ5c2NvcmUgQGVycm9yc1NldEtleSgpLCAwLCB0aW1lc3RhbXAsIChlcnIpID0+XG4gICAgICAgICAgcmV0dXJuIGNiIGNyZWF0ZUVycm9yKGVycikgaWYgZXJyXG4gICAgICAgICAgYXN5bmNUYXNrcyA9IF8ubWFwIHRhc2tzLCAodGFzaykgPT4gKG5leHQpID0+IEBwdXNoSm9iIEpTT04ucGFyc2UodGFzayksIG5leHRcbiAgICAgICAgICBhc3luYy5wYXJhbGxlbCBhc3luY1Rhc2tzLCBjYlxuXG4gIHBvcEpvYkZyb21RdWV1ZTogKGNiKSAtPlxuICAgICMgY29uc29sZS5sb2cgJz4+IFBPUEpPQidcbiAgICBAb2J0YWluTGlzdENsaWVudCAoZXJyLCBjbGllbnQpID0+XG4gICAgICByZXR1cm4gY2IgY3JlYXRlRXJyb3IoZXJyLCAnTElTVE5PVEZPVU5EJykgaWYgZXJyXG4gICAgICBjbGllbnQubHBvcCBAbGlzdEtleSgpLCBjYlxuXG4gIGNoZWNrQW5kUnVuVGFzazogKGNiKSAtPlxuICAgICMgY29uc29sZS5sb2cgJz4gQ0hFQ0tSVU4nXG4gICAgQHBvcEpvYkZyb21RdWV1ZSAoZXJyLHRhc2spID0+XG4gICAgICByZXR1cm4gY2IgY3JlYXRlRXJyb3IoZXJyLCAnUE9QSk9CJykgaWYgZXJyXG4gICAgICB1bmxlc3MgdGFza1xuICAgICAgICAjIGNvbnNvbGUubG9nICc+Pj4gTk8gTU9SRSBUQVNLUydcbiAgICAgICAgQHJlZGlzUXVldWVFbXB0eSA9IHRydWVcbiAgICAgICAgcmV0dXJuIGNiKClcblxuICAgICAgQHJlZGlzUXVldWVFbXB0eSA9IGZhbHNlXG4gICAgICAjIGNvbnNvbGUubG9nICc+Pj4gVEFTSyBTVEFSVCBKT0InXG5cbiAgICAgIEBpbmNSdW5uaW5nVGFza3MoKVxuICAgICAgQHdvcmsgdGFzaywgKHRhc2tFcnIpID0+XG4gICAgICAgIEBkZWNSdW5uaW5nVGFza3MoKVxuICAgICAgICByZXR1cm4gY2IoKSB1bmxlc3MgdGFza0VyclxuXG4gICAgICAgIEBlcnJvciB0YXNrRXJyLCB0YXNrLCAodGFza0VycikgPT5cbiAgICAgICAgICByZXR1cm4gY2IgbnVsbCB1bmxlc3MgdGFza0VyclxuICAgICAgICAgIEBwdXNoRXJyb3JKb2IgdGFzaywgKGVycikgLT5cbiAgICAgICAgICAgIHJldHVybiBjYiBlcnIgaWYgZXJyXG4gICAgICAgICAgICByZXR1cm4gY2IgY3JlYXRlRXJyb3IodGFza0VyciwgJ1JVTlRBU0snKSBpZiB0YXNrRXJyXG4gICAgICAgICAgICBjYiBudWxsXG5cbiAgIyBTdWJjbGFzcyBBUElcbiAgd29yazogKCkgLT5cbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1lvdSBtdXN0IG92ZXJ3cml0ZSBXb3JrZXIjd29yayBpbiBzdWJjbGFzcycpXG5cbiAgZXJyb3I6ICgpIC0+XG4gICAgdGhyb3cgbmV3IEVycm9yKCdZb3UgbXVzdCBvdmVyd3JpdGUgV29ya2VyI2Vycm9yIGluIHN1YmNsYXNzJylcblxuICBoYW5kbGVUYXNrRG9tYWluRXJyb3I6IChlcnIpID0+XG4gICAgY29uc29sZS5lcnJvciBcIkRldGVjdGVkIGFuIHVua25vd24gZXJyb3IgPCN7ZXJyfT4sIHNodXR0aW5nIGRvd24gYWZ0ZXIgdGhpcyBjeWNsZSBvciBpbiAje0BncmFjZWZ1bFNodXRkb3duVGltZW91dC8xMDAwLjB9IHNlY29uZHMuXCJcbiAgICBjb25zb2xlLmVycm9yIGVyci5zdGFja1xuXG4gICAgdW5sZXNzIEBzaHV0dGluZ0Rvd25cbiAgICAgIEBzaHV0dGluZ0Rvd24gPSB0cnVlXG5cbiAgICAgIHBvc3RXb3JrSG9vayA9ICgpID0+XG4gICAgICAgICMgRmxhZyB1c2VkIGluIHRlc3RpbmcsIHdoZXJlIHdlIG1vY2sgJ3Byb2Nlc3MuZXhpdCcuXG4gICAgICAgICMgVW5kZXIgbm9ybWFsIGNpcmN1bXN0YW5jZXNzIHByb2Nlc3MuZXhpdCB3aWxsIGtpbGwgdGhpcyB3b3JrZXIgaW1tZWRpYXRlbHkuXG4gICAgICAgIHVubGVzcyBAc2h1dERvd25cbiAgICAgICAgICBjb25zb2xlLndhcm4gXCJQb3N0IHdvcmssIHNodXR0aW5nIGRvd24uXCJcbiAgICAgICAgICBAd29ya2VyRG9tYWluLmRpc3Bvc2UoKVxuICAgICAgICAgIHByb2Nlc3MuZXhpdCAtMVxuXG4gICAgICAgIEBzaHV0RG93biA9IHRydWVcblxuICAgICAgQGRyYWluQ2FsbGJhY2sgPSBwb3N0V29ya0hvb2tcbiAgICAgIHNldFRpbWVvdXQgcG9zdFdvcmtIb29rLCBAZ3JhY2VmdWxTaHV0ZG93blRpbWVvdXRcblxuICAgIEBkZWNSdW5uaW5nVGFza3MoKVxuXG4gICMgQVBJXG4gIHdhaXRGb3JUYXNrczogKGNiKSAtPlxuICAgIEBvYnRhaW5DaGFubmVsQ2xpZW50IChlcnIsIGNoYW5uZWxfY2xpZW50KSA9PlxuICAgICAgcmV0dXJuIGNiIGNyZWF0ZUVycm9yKGVyciwgJ0NIQU5ORUxOT1RGT1VORCcpIGlmIGVyclxuXG4gICAgICBAb2J0YWluTGlzdENsaWVudCAoZXJyLCBsaXN0X2NsaWVudCkgPT4gIyBAVE9ETzogV2h5IGlzIHRoaXMgbmVjZXNzYXJ5P1xuICAgICAgICBsaXN0X2NsaWVudC5sbGVuIEBsaXN0S2V5KCksIChlcnIsIGxlbmd0aCkgPT5cbiAgICAgICAgICBwcmVxdWV1ZWRUYXNrc05vID0gTWF0aC5tYXgoMSwgTWF0aC5taW4obGVuZ3RoLCBAdGFza0xpbWl0KSlcblxuICAgICAgICAgIEBfZmV0Y2hKb2JGcm9tUmVkaXNUb1F1ZXVlKCkgZm9yIGlkeCBpbiBbMS4ucHJlcXVldWVkVGFza3NOb10gaWYgbGVuZ3RoXG5cbiAgICAgICMgQFRPRE86IFdoeSBkb2Vzbid0IHRoaXMgYWxvbmUgd29yaz9cbiAgICAgICMgQF9mZXRjaEpvYkZyb21SZWRpc1RvUXVldWUoKSBmb3IgaWR4IGluIFsxLi4yXVxuXG4gICAgICBzZXRJbnRlcnZhbCBAaGFuZGxlRXJyb3JUYXNrcywgQHJldHJ5UG9wVGFza3NJbnRlcnZhbCBpZiBAcmV0cnlUYXNrc1xuXG4gICAgICBjaGFubmVsX2NsaWVudC5vbiAnbWVzc2FnZScsIChjaGFubmVsLCBtZXNzYWdlKSA9PlxuICAgICAgICAjIGNvbnNvbGUubG9nICdcXG4+Pj4+PiBNU0cnLCBtZXNzYWdlLnN1YnN0cigzOCw3MCksICdcXG4nXG4gICAgICAgIGlmIGNoYW5uZWwgPT0gQGNoYW5uZWxLZXkoKVxuICAgICAgICAgIHJldHVybiB1bmxlc3MgQF9jYW5UYWtlTmV3VGFza3MoKVxuICAgICAgICAgIEBfZmV0Y2hKb2JGcm9tUmVkaXNUb1F1ZXVlKHRydWUpXG5cbiAgICAgIGNoYW5uZWxfY2xpZW50LnN1YnNjcmliZShAY2hhbm5lbEtleSgpKVxuXG4gICAgICBjYigpXG5cbiAgaGFuZGxlRXJyb3JUYXNrczogKCkgPT5cbiAgICBAcG9wRXJySm9iRnJvbVF1ZXVlIChlcnIpIC0+IGNvbnNvbGUuZXJyb3IgZXJyIGlmIGVyclxuXG4gIHB1c2hFcnJvckpvYjogKHBheWxvYWQsIGNiKSAtPlxuICAgIHJldHVybiBjYiBudWxsIHVubGVzcyBAcmV0cnlUYXNrc1xuICAgIGpvYkRpY3QgPSBKU09OLnBhcnNlKHBheWxvYWQpXG4gICAgam9iRGljdFsndGltZXNfcmV0cmllZCddID0gLTEgdW5sZXNzIGpvYkRpY3QudGltZXNfcmV0cmllZD9cbiAgICBqb2JEaWN0LnRpbWVzX3JldHJpZWQrK1xuICAgIHJldHVybiBjYiBudWxsIGlmIGpvYkRpY3QudGltZXNfcmV0cmllZCA+PSBAbWF4UmV0cmllc1xuICAgIHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShqb2JEaWN0KVxuICAgIGFzeW5jLnNlcmllcyBbXG4gICAgICAobmV4dCkgPT5cbiAgICAgICAgQG9idGFpbkVycm9yc1NldENsaWVudCAoZXJyLCBjbGllbnQpID0+XG4gICAgICAgICAgcmV0dXJuIG5leHQgY3JlYXRlRXJyb3IoZXJyLCAnRVJSU0VUTk9URk9VTkQnKSBpZiBlcnJcbiAgICAgICAgICBjbGllbnQuemFkZCBAZXJyb3JzU2V0S2V5KCksIG1vbWVudC51dGMoKS5hZGQoQF9jYWxjdWxhdGVCYWNrb2ZmKGpvYkRpY3QudGltZXNfcmV0cmllZCksJ21zJykudW5peCgpLCBwYXlsb2FkLCBuZXh0XG4gICAgICAobmV4dCkgPT5cbiAgICAgICAgQG9idGFpbkVycm9yc1NldENsaWVudCAoZXJyLCBjbGllbnQpID0+XG4gICAgICAgICAgcmV0dXJuIG5leHQgY3JlYXRlRXJyb3IoZXJyLCAnRVJSU0VUTk9URk9VTkQnKSBpZiBlcnJcbiAgICAgICAgICBjbGllbnQucHVibGlzaCBAY2hhbm5lbEtleSwgcGF5bG9hZCwgbmV4dFxuICAgIF0sIChlcnIpIC0+XG4gICAgICByZXR1cm4gY2IgY3JlYXRlRXJyb3IoZXJyLCAnUFVTSEVSUkpPQicpIGlmIGVyclxuICAgICAgY2IgbnVsbFxuXG4gIHB1c2hKb2I6IChqb2JEaWN0LCBjYikgLT5cbiAgICAjIGNvbnNvbGUubG9nICdQVVNISk9CJ1xuICAgIHBheWxvYWQgPSBKU09OLnN0cmluZ2lmeShqb2JEaWN0KVxuICAgIGFzeW5jLnNlcmllcyBbXG4gICAgICAoY2FsbGJhY2spID0+XG4gICAgICAgIEBvYnRhaW5MaXN0Q2xpZW50IChlcnIsY2xpZW50KSA9PlxuICAgICAgICAgIHJldHVybiBjYWxsYmFjayBjcmVhdGVFcnJvcihlcnIsICdMSVNUTk9URk9VTkQnKSBpZiBlcnJcbiAgICAgICAgICBjbGllbnQucnB1c2ggQGxpc3RLZXkoKSwgcGF5bG9hZCwgY2FsbGJhY2tcbiAgICAgIChjYWxsYmFjaykgPT5cbiAgICAgICAgQG9idGFpbkxpc3RDbGllbnQgKGVycixjbGllbnQpID0+XG4gICAgICAgICAgcmV0dXJuIGNhbGxiYWNrIGNyZWF0ZUVycm9yKGVyciwgJ0xJU1ROT1RGT1VORCcpIGlmIGVyclxuICAgICAgICAgIGNsaWVudC5wdWJsaXNoIEBjaGFubmVsS2V5KCksIHBheWxvYWQsIGNhbGxiYWNrXG4gICAgXSwgKGVycikgLT5cbiAgICAgIHJldHVybiBjYiBjcmVhdGVFcnJvcihlcnIsICdQVVNISk9CJykgaWYgZXJyXG4gICAgICBjYiBudWxsXG5cbiAgX2NhblRha2VOZXdUYXNrczogKCkgLT5cbiAgICByZXR1cm4gQHF1ZXVlLnJ1bm5pbmcoKStAcXVldWUubGVuZ3RoKCkgPCBAdGFza0xpbWl0XG5cbiAgX2ZldGNoSm9iRnJvbVJlZGlzVG9RdWV1ZTogKGZvcmNlKSAtPlxuICAgIGlmIChub3QgQHJlZGlzUXVldWVFbXB0eSBvciBmb3JjZSkgYW5kIG5vdCBAc2h1dHRpbmdEb3duXG4gICAgICB0bXBUYXNrTm8gPSBAdGFza05vXG4gICAgICBAcXVldWUucHVzaCBAdGFza05vLCAoZXJyKSAtPlxuICAgICAgICAjIGNvbnNvbGUubG9nICdcXG4+Pj4+IEZJTklTSEVEIFRBU0snLCB0bXBUYXNrTm8sICdcXG4nXG4gICAgICAgIHJldHVyblxuICAgICAgIyBjb25zb2xlLmxvZyAnPj4+Pj4gRkVUQ0hFRCBqb2IgYW5kIGFkZGVkIHRvIFFVRVVFJ1xuICAgICAgIyBjb25zb2xlLmxvZyAndGFza05vJywgQHRhc2tOb1xuICAgICAgIyBjb25zb2xlLmxvZyAndGFza0xpbWl0JywgQHRhc2tMaW1pdFxuICAgICAgIyBjb25zb2xlLmxvZyAnY2FuIHRha2UgbmV3IHRhc2tzJywgQF9jYW5UYWtlTmV3VGFza3MoKVxuICAgICAgQHRhc2tObysrXG5cbiAgX2NhbGN1bGF0ZUJhY2tvZmY6IChudW1SZXRyaWVzKSAtPlxuICAgICMgcmFuZE11bHRpcGxpZXIgPSBNYXRoLmNlaWwoTWF0aC5yYW5kb20oKSAqICgyICoqIChudW1SZXRyaWVzICsgMikgLSAxKSlcbiAgICByYW5kTXVsdGlwbGllciA9IE1hdGgucmFuZG9tKCkgKiAoMiAqKiAobnVtUmV0cmllcyArIDIpIC0gMSlcbiAgICByYW5kTXVsdGlwbGllciA9IDEgaWYgbnVtUmV0cmllcyBpcyAwXG4gICAgKEBiYWNrb2ZmSW50ZXJ2YWwgKiByYW5kTXVsdGlwbGllcikudG9GaXhlZCgyKVxuIFxuXG4jIyMgIyMjXG4jIEVYUE9SVFNcbmV4cG9ydHMuV29ya2VyID0gV29ya2VyXG5leHBvcnRzLldvcmtlckVycm9yID0gV29ya2VyRXJyb3JcbiJdfQ==